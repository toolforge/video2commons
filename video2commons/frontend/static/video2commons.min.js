(d=>{var o,r,s,n,i,l=window.config,u=window.i18n,a='<img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32">',e="rtl"===u["@dir"],c={abortbutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-remove"></span> '+nunjucks.lib.escape(u.abort)+"</button>",removebutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right remove-btn"><span class="glyphicon glyphicon-trash"></span> '+nunjucks.lib.escape(u.remove)+"</button>",restartbutton:'<button type="button" class="btn btn-xs flip pull-right restart-btn"><span class="glyphicon glyphicon-repeat"></span> '+nunjucks.lib.escape(u.restart)+"</button>",loading:"<center>"+a+"&nbsp;&nbsp;"+nunjucks.lib.escape(u.loading)+"</center>",errorDisconnect:'<div class="alert alert-danger">'+nunjucks.lib.escape(u.errorDisconnect)+"</div>",yourTasks:"<h4>"+nunjucks.lib.escape(u.yourTasks)+'</h4><table id="tasktable" class="table"><colgroup><col style="width: 20%;"/><col style="width: 10%;"/><col style="width: 40%;"/><col style="width: 30%;"/></colgroup><tbody></tbody></table>',workers:"<h4>"+nunjucks.lib.escape(u.workers)+"</h4>",capacity:e?`<div><span id="capacity">...</span> ${u.capacity}</div>`:`<div>${u.capacity} <span id="capacity">...</span></div>`,utilization:e?`<div><span id="utilization">...</span> ${u.utilization}</div>`:`<div>${u.utilization} <span id="utilization">...</span></div>`,pending:e?`<div><span id="pending">...</span> ${u.pending}</div>`:`<div>${u.pending} <span id="pending">...</span></div>`,addTask:'<input class="btn btn-primary btn-md" type="button" accesskey="n" value="'+nunjucks.lib.escape(u.addTask)+'">',requestServerSide:'<a class="btn btn-primary btn-success btn-md flip pull-right disabled" id="ssubtn">'+nunjucks.lib.escape(u.createServerSide)+"</a>",progressbar:'<div class="progress"><div class="progress-bar" role="progressbar"></div></div>',prevbutton:'<span class="glyphicon glyphicon-chevron-'+(e?"right":"left")+'"></span> '+nunjucks.lib.escape(u.back),nextbutton:nunjucks.lib.escape(u.next)+' <span class="glyphicon glyphicon-chevron-'+(e?"left":"right")+'"></span>',confirmbutton:nunjucks.lib.escape(u.confirm)},p="",f=(new nunjucks.Environment).addGlobal("config",l).addGlobal("_",function(e){return u[e]}).addFilter("process_link",function(e){for(var t,a=/\{\{#a\}\}(.*?)\{\{\/a\}\}/g,n=0,i="";null!==(t=a.exec(e));)i=(i+=nunjucks.lib.escape(e.substring(n,t.index)))+(e=>{if("#"===e[0]){var t=e.indexOf("|");if(t<0){if(/^[a-z0-9-]+$/i.test(e.slice(1)))return'<a id="'+e.slice(1)+'"></a>'}else if(/^[a-z0-9-]+$/i.test(e.substring(1,t)))return'<a id="'+e.substring(1,t)+'">'+nunjucks.lib.escape(e.slice(t+1))+"</a>"}return"<a>"+nunjucks.lib.escape(e)+"</a>"})(t[1]),n=a.lastIndex;return i+=nunjucks.lib.escape(e.slice(n)),new nunjucks.runtime.SafeString(i)});function h(e,t){var a,n,i,o;return t?!e.video&&e.audio?(a=(e=t).match(/^Audio files of (\d{4})$/))?(a=parseInt(a[1],10),(new Date).getFullYear()<a?{valid:!1,error:"The year must not be in the future."}:{valid:!0,value:e}):{valid:!1,error:u["datecategory-audio-error-format"]}:(e=(a=t).match(/^Videos of (\d{4})$/))?(e=parseInt(e[1],10),(new Date).getFullYear()<e?{valid:!1,error:u["datecategory-error-future-year"]}:{valid:!0,value:a}):(e=a.match(/^Videos taken on (\d{4})-(\d{2})-(\d{2})$/))?(t=parseInt(e[1],10),n=parseInt(e[2],10),e=parseInt(e[3],10),i=new Date(t,n-1,e),o=new Date,i.getFullYear()!==t||i.getMonth()!==n-1||i.getDate()!==e||o<i?{valid:!1,error:u["datecategory-error-invalid-date"]}:{valid:!0,value:a}):{valid:!1,error:u["datecategory-video-error-format"]}:{valid:!0,value:null}}function m(e){return(e.audio&&!e.video?b:v)(e)[0]}function v(e){var t=(new Date).toISOString().split("T")[0],e=e.date||t;return["Videos of "+e.split("-")[0],"Videos taken on "+e]}function b(e){var t=(new Date).toISOString().split("T")[0];return["Audio files of "+(e.date||t).split("-")[0]]}let g={getSourceData:function(){return{url:o.find("#url").val(),video:o.find("#video").is(":checked"),audio:o.find("#audio").is(":checked"),subtitles:o.find("#subtitles").is(":checked")}},getTargetData:function(){return{filename:o.find("#filename").val().trim(),format:o.find("#format").val(),filedesc:o.find("#filedesc").val(),dateCategory:o.find("#dateCategory").val().trim()}},getPlaylistData:function(){let t=[];return o.find(".video-select:checked").each(function(){var e=parseInt(d(this).val(),10),e=r.videos[e];t.push(e)}),t}},k={startTask:function(e){return w.apiPost("task/run",e)},updateFormats:function(e,t){return 0<r.formats.length&&e===r.video&&t===r.audio?d.when():w.askAPI("listformats",{video:e,audio:t},["video","audio","format","formats"])},updateUrl:function(t){var e;return t?t===r.url&&r.initialFilenameValidated?d.when():(e=r.uploadedFile[t])?(r.url=t,w.askAPI("makedesc",{filename:e.name||""},["extractor","filedesc","filename"])):w.askAPI("validateurl",{url:t},["entity_url"]).then(function(e){return e.entity_url?d.Deferred().reject("This video has already been uploaded: "+e.entity_url).promise():w.askAPI("extracturl",{url:t},["type","id","title","url","date","extractor","filedesc","filename","videos"]).then(()=>{r.initialFilenameValidated=!0})}).then(function(){"playlist"===r.type?r.videos.forEach(e=>{e.format=r.format,e.dateCategory=m(e)}):r.dateCategory=m(r)}):d.Deferred().reject("URL cannot be empty!").promise()},updateFilename:function(e,t=null){return null==t&&(t=r),e?e===t.filename&&t.initialFilenameValidated?d.when():w.askAPI("validatefilename",{filename:e},[],t).then(function(){return w.askAPI("validatefilenameunique",{filename:e},["filename"],t)}).then(function(){t.initialFilenameValidated=!0}):d.Deferred().reject("Filename cannot be empty!").promise()},updateFiledesc:function(e,t=null){return null==t&&(t=r),e?e===t.filedesc&&t.initialFiledescValidated?d.when():w.askAPI("validatefiledesc",{filedesc:e},["filedesc"],t).then(function(){t.initialFiledescValidated=!0}):d.Deferred().reject("Decription cannot be empty!").promise()},validateUrl:function(e){return w.askAPI("validateurl",{url:e},[]).then(e=>{if(e.entity_url)return d.Deferred().reject("This video has already been uploaded: "+e.entity_url).promise()})}},y={source:function(){var e=g.getSourceData();return r={...r,...e,selectedVideos:[]},d.when(k.updateFormats(e.video,e.audio),k.updateUrl(e.url)).then(()=>{"playlist"===r.type?r.nextStep="playlist":r.nextStep="target"})},playlist:function(){let t=g.getPlaylistData();var e;return 0===t.length?d.Deferred().reject("Please select at least one video to upload!").promise():(e=[...t.map(e=>()=>k.updateFilename(e.filename,e)),...t.map(e=>()=>k.updateFiledesc(e.filedesc,e)),...t.map(e=>()=>k.validateUrl(e.url))],d.when(w.runWithConcurrency(e)).then(e=>{e=e.filter(e=>!!e?.error);if(0<e.length)return d.Deferred().reject(e.map(e=>e.error).join("\n\n")).promise();r.selectedVideos=t,r.nextStep="confirm"}))},target:function(){var e=g.getTargetData(),t="playlist"===r.type?r.videos[r.editingVideoIndex]:r,a=(t.format=e.format,h(t,e.dateCategory));return a.valid?(t.dateCategory=a.value,d.when(k.updateFilename(e.filename,t),k.updateFiledesc(e.filedesc,t)).then(()=>{"playlist"===r.type?r.nextStep="playlist":r.nextStep="confirm"})):d.Deferred().reject(a.error).promise()},confirm:function(){return d.when().then(()=>{r.nextStep=null})}};var w=window.video2commons={init:function(){d("#content").html(c.loading),n={},w.loadCsrf(w.checkStatus),d(window).on("beforeunload",function(e){if(o&&o.is(":visible"))return e.preventDefault(),e.returnValue=""});var e=/^#?!(https?:\/\/.+)/;e.test(window.location.hash)?w.addTask({url:window.location.hash.match(e)[1]}):window.location.search.slice(1)&&(s=Qs.parse(window.location.search.slice(1)),w.addTask({url:s.url}))},loadCsrf:function(t){d.get("api/csrf").done(function(e){p=e.csrf,t()})},checkStatus:function(){l.socketio_uri&&window.WebSocket&&window.io?w.checkStatusSocket():w.checkStatusLegacy()},checkStatusSocket:function(){var e,t,a;window.socket||(t=(e=l.socketio_uri.match(/^((?:(?:https?:)?\/\/)?[^/]+)(\/.*)$/))[1],(a=window.socket=io(t,{path:e[2]})).on("connect",function(){d.get("api/iosession").done(function(e){a.emit("auth",{iosession:e.iosession,_csrf_token:p})})}),a.on("status",function(e){w.alterTaskTableBoilerplate(function(){w.populateResults(e)})}),a.on("update",function(e,t){w.alterTaskTableBoilerplate(function(){w.updateTask(t)})}),a.on("remove",function(e){w.alterTaskTableBoilerplate(function(){d("#task-"+e).remove()})}))},checkStatusLegacy:function(){window.lastStatusCheck&&clearTimeout(window.lastStatusCheck);d.get("api/status").done(function(e){w.alterTaskTableBoilerplate(function(){w.populateResults(e)}),window.lastStatusCheck=setTimeout(w.checkStatusLegacy,5e3)}).fail(function(){d("#content").html(c.errorDisconnect)})},setupTables:function(){d("#content").empty(),d("#content").append(c.workers),d("#content").append(c.capacity),d("#content").append(c.utilization),d("#content").append(c.pending),d("#content").append(c.yourTasks);var e=d(c.addTask),e=(d("#content").append(e),e.click(function(){w.addTask()}),d(c.requestServerSide));d("#content").append(e.hide())},alterTaskTableBoilerplate:function(e){d("#tasktable").length||w.setupTables();var t=window.innerHeight+window.scrollY>=document.body.offsetHeight;e(),d.isEmptyObject(n)?d("#ssubtn").addClass("disabled").hide():d("#ssubtn").removeClass("disabled").show().attr("href",w.makeSSULink(n)),t&&window.scrollTo(0,document.body.scrollHeight)},populateResults:function(e){i=e.username;var t=d("#tasktable > tbody"),a=[];d.each(e.values,function(e,t){w.updateTask(t),a.push(t.id)}),t.find("> tr").each(function(){var e=d(this),t=w.getTaskIDFromDOMID(e.attr("id"));a.indexOf(t)<0&&e.remove()}),e.stats?(d("#capacity").text(e.stats.processing+" / "+e.stats.capacity),d("#utilization").text(Math.round(100*e.stats.utilization)+"%"),d("#pending").text(""+e.stats.pending)):(d("#capacity").text("N/A"),d("#utilization").text("N/A"),d("#pending").text("N/A"))},updateTask:function(e){function t(e,t,a){var n=o.find("#"+i+"-statustext");t?(t=n.html(e).find("a").attr("href",t),a&&t.text(a)):n.text()!==e&&n.text(e)}var a=d("#tasktable > tbody"),i="task-"+e.id,o=d("#"+i),a=(o.length?o.attr("status")!==e.status&&(o.html(""),w.setupTaskRow(o,i,e.status)):(d("#task-new").remove(),(o=d("<tr />")).attr({id:i,status:e.status}),a.append(o),w.setupTaskRow(o,i,e.status)),o.find("#"+i+"-title")),a=(a.text()!==e.title&&a.text(e.title),o.find("#"+i+"-hostname"));a.text()!==e.hostname&&a.text(e.hostname??"N/A");"done"===e.status?t(f.getFilter("process_link")(u.taskDone).toString(),e.url.replace("%3A",":"),e.text):"needssu"===e.status?t(f.getFilter("process_link")(u.errorTooLarge).toString(),w.makeSSULink([e])):"fail"===e.status?(t(e.text,e.url,e.url),e.restartable?o.find("#"+i+"-restartbutton").show().off().click(function(){w.eventTask(this,"restart")}):o.find("#"+i+"-restartbutton").off().hide()):t(e.text),"progress"===e.status&&w.setProgressBar(o.find("#"+i+"-progress"),e.progress),"needssu"===e.status?n[e.id]=e:delete n[e.id]},setupTaskRow:function(e,t,a){switch(a){case"progress":e.append(d("<td />").attr("id",t+"-title")).append(d("<td />").attr("id",t+"-hostname")).append(d("<td />").attr("id",t+"-status").append(d("<span />").attr("id",t+"-statustext"))).append(d("<td />").attr("id",t+"-progress"));var n=w.eventButton(t,"abort"),n=(e.find("#"+t+"-status").append(n),e.find("#"+t+"-progress").html(c.progressbar));w.setProgressBar(n,-1),e.removeClass("success danger");break;case"done":w.appendButtons([w.eventButton(t,"remove")],e,["danger","success"],t);break;case"fail":var n=w.eventButton(t,"remove"),i=w.eventButton(t,"restart").hide();w.appendButtons([n,i],e,["success","danger"],t);break;case"needssu":w.appendButtons([w.eventButton(t,"remove")],e,["success","danger"],t);break;case"abort":w.appendButtons([],e,["success","danger"],t)}e.attr("status",a)},makeSSULink:function(e){var t=d.map(e,function(e){return"* "+e.url}).join("\n"),e=d.map(e,function(e){return"| "+e.filename+" | "+e.hashsum+" |"}).join("\n");return"https://phabricator.wikimedia.org/maniphest/task/edit/form/106/?"+d.param({title:"Server side upload for "+i,projects:"video2commons,server-side-upload-request",description:"Please upload these file(s) to Wikimedia Commons:\n\n**URLs**\n\n{{{ urls }}}\n\n//Description files are available too: append `.txt` to the URLs.//\n\n**Checksums**\n\n| **File** | **MD5** |\n{{{ checksums }}}\n\nThank you!".replace("{{{ urls }}}",t).replace("{{{ checksums }}}",e)})},setProgressBar:function(e,t){e=e.find(".progress-bar");t<0?(e.addClass("progress-bar-striped active").addClass("active").text(""),t=100):e.removeClass("progress-bar-striped active").text(Math.round(t)+"%"),e.attr({"aria-valuenow":t,"aria-valuemin":"0","aria-valuemax":"100",style:"width:"+t+"%"})},getTaskIDFromDOMID:function(e){return/^(?:task-)?(.+?)(?:-(?:title|statustext|progress|abortbutton|removebutton|restartbutton))?$/.exec(e)[1]},eventTask:function(e,t){e=d(e);e.is(".disabled")||(e.off().addClass("disabled"),w.apiPost("task/"+t,{id:w.getTaskIDFromDOMID(e.attr("id"))}).done(function(e){e.error&&window.alert(e.error),w.checkStatus()}))},setText:function(e,t){for(var a=0;a<e.length;a++)o.find("#"+e[a]).text(t[e[a]])},eventButton:function(e,t){return d(c[t+"button"]).attr("id",e+"-"+t+"button").off().click(function(){w.eventTask(this,t)})},appendButtons:function(e,t,a,n){t.append(d("<td />").attr("id",n+"-title"));var i=d("<td />").attr("id",n+"-status").attr("colspan","3").append(d("<span />").attr("id",n+"-statustext"));e.length&&i.append(e[0]);for(var o=1;o<e.length;o++)i.append(e[o]);t.append(i).removeClass(a[0]).addClass(a[1])},addTask:function(e){o||((o=d("<div>").html(f.render("addTask.html"))).addClass("modal fade").attr({id:"addTaskDialog",role:"dialog"}),d("body").append(o),o.find("#btn-prev").html(c.prevbutton),o.find("#btn-next").html(c.nextbutton),o.find("#btn-cancel").click(function(){w.abortUpload()}),o.find(".modal-body").keypress(function(e){13!==(e.which||e.keyCode)||d(":focus").is("textarea")||(o.find(".modal-footer #btn-next").click(),e.preventDefault())})),w.openTaskModal(e)},openTaskModal:function(e){o.find("#dialog-spinner").hide(),o.find(".modal-body").html("<center>"+a+"</center>"),w.newTask(e),o.modal({backdrop:"static"}),o.on("shown.bs.modal",function(){o.find("#url").focus()}),w.reactivatePrevNextButtons()},newTask:function(e){r={step:"source",url:"",date:"",extractor:"",audio:!0,video:!0,subtitles:!0,filename:!0,formats:[],format:"",filedesc:"",dateCategory:"",uploadedFile:{},initialUrlValidated:!1,initialFilenameValidated:!1,initialFiledescValidated:!1,nextStep:"source",history:[],videos:[],selectedVideos:[],editingVideoIndex:null},d.extend(r,e),w.setupAddTaskDialog()},setupAddTaskDialog:function(){switch(r.step){case"source":o.find(".modal-body").html(f.render("sourceForm.html")),o.find("a#fl").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Acceptable_licenses"),o.find("a#pd").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Material_in_the_public_domain"),o.find("a#fu").attr("href","//commons.wikimedia.org/wiki/Commons:FU"),o.find("#url").val(r.url).on("input",function(){r.url!==d(this).val()&&(r.url=d(this).val());r.url.match(/(https?:\/\/)?(www\.)?(youtube|youtu|youtube-nocookie)\.(com|be)\/(watch\?.*?(?=v=)v=|embed\/|v\/|.+\?v=)?([^&=%\?]{11})/)?o.find("#youtube-warning").removeClass("hidden"):o.find("#youtube-warning").addClass("hidden")}).focus(),o.find("#video").prop("checked",r.video),o.find("#audio").prop("checked",r.audio),o.find("#subtitles").prop("checked",r.subtitles),w.initUpload();break;case"playlist":o.find(".modal-body").html(f.render("playlistForm.html",{task:r})),o.find(".video-select").each((e,t)=>{e=r.videos[e];0<=r.selectedVideos.indexOf(e)&&d(t).prop("checked",!0)});var e=o.find(".video-select:checked").length===o.find(".video-select").length;o.find("#select-all").prop("checked",e),o.find("#select-all").off().change(function(){var e=d(this).is(":checked");o.find(".video-select").prop("checked",e)}),o.find(".video-select").off().change(function(){var e=o.find(".video-select:checked").length===o.find(".video-select").length;o.find("#select-all").prop("checked",e)}),o.find(".btn-edit").off().click(function(){var e=d(this).data("video-index");r.selectedVideos=g.getPlaylistData(),r.editingVideoIndex=e,r.history.push(r.step),r.step="target",w.setupAddTaskDialog(),w.reactivatePrevNextButtons()});break;case"target":let t="playlist"===r.type?r.videos[r.editingVideoIndex]:r;o.find(".modal-body").html(f.render("targetForm.html",{source:t})),o.find("#filename").val(t.filename.trim()).focus(),d.each(r.formats,function(e,t){o.find("#format").append(d("<option></option>").text(t))}),o.find("#format").val(t.format),o.find("#filedesc").val(t.filedesc),o.find("#dateCategory").attr("placeholder",(e=t,a=(new Date).toISOString().split("T")[0],n=(a=e.date||a).split("-")[0],i=(e=e.audio&&!e.video)?u["datecategory-audio-placeholder"]:u["datecategory-video-placeholder"],e?i.replace("$1",n):i.replace("$1",n).replace("$2",a))).val(t.dateCategory||"");n=((i=t).audio&&!i.video?b:v)(i);d.each(n,function(e,t){o.find("#dateCategoryOptions").append(d("<option></option>").val(t))}),o.find("#dateCategory").on("input",function(){var e=h(t,d(this).val().trim());e.valid?(o.find("#dateCategoryError").hide(),o.find("#dateCategory-group").removeClass("has-error")):(o.find("#dateCategoryError").text(e.error).show(),o.find("#dateCategory-group").addClass("has-error"))});break;case"confirm":a="playlist"===r.type?f.render("playlistConfirmForm.html",{task:r}):f.render("confirmForm.html"),i=(o.find(".modal-body").html(a),[]);r.video&&i.push(u.video),r.audio&&i.push(u.audio),r.subtitles&&i.push(u.subtitles),o.find("#keep").text(i.join(", ")),w.setText(["url","extractor","filename","format"],r),o.find("#filedesc").val(r.filedesc),o.find("#btn-next").focus()}var a,n,i},reactivatePrevNextButtons:function(){switch(o.find("#dialog-spinner").hide(),r.step){case"source":o.find("#btn-prev").addClass("disabled").off(),o.find("#btn-next").html(c.nextbutton),w.setPrevNextButton("next");break;case"playlist":w.setPrevNextButton("prev"),o.find("#btn-next").html(c.nextbutton),w.setPrevNextButton("next");break;case"target":w.setPrevNextButton("prev"),"playlist"===r.type?o.find("#btn-next").html(c.confirmbutton):o.find("#btn-next").html(c.nextbutton),w.setPrevNextButton("next");break;case"confirm":w.setPrevNextButton("prev"),o.find("#btn-next").removeClass("disabled").html(c.confirmbutton).off().click(function(){w.disablePrevNext(!1),o.modal("hide"),d("#tasktable > tbody").append('<tr id="task-new"><td colspan="3">'+a+"</td></tr>"),window.scrollTo(0,document.body.scrollHeight),r.uploadedFile={};let t=[];if("playlist"===r.type)t=r.selectedVideos.map(e=>{let t=e.filedesc;return e.dateCategory&&(t+="\n[[Category:"+e.dateCategory+"]]"),{url:e.url,extractor:e.extractor,subtitles:r.subtitles,filename:e.filename,filedesc:t,format:e.format}});else{let e=r.filedesc;r.dateCategory&&(e+="\n[[Category:"+r.dateCategory+"]]"),t.push({url:r.url,extractor:r.extractor,subtitles:r.subtitles,filename:r.filename,filedesc:e,format:r.format})}w.runWithConcurrency(t.map(e=>()=>k.startTask(e).done(e=>{e.error&&window.alert(e.error)}))).always(()=>{w.checkStatus()})})}},setPrevNextButton:function(e){o.find("#btn-"+e).removeClass("disabled").off().click(function(){w.processInput(e)})},disablePrevNext:function(e){o.find(".modal-body #dialog-errorbox").hide(),o.find("#btn-prev").addClass("disabled").off(),o.find("#btn-next").addClass("disabled").off(),e&&o.find("#dialog-spinner").show()},processInput:function(e){var t=r.step,a=y[t];a?"next"===e?(a=a(),w.promiseWorkingOn(a.done(function(){w.transitionStep(e)}))):(w.transitionStep(e),w.reactivatePrevNextButtons()):console.error("Unknown step:",t)},transitionStep:function(e){"prev"===e&&0<r.history.length?(r.step=r.history.pop(),w.setupAddTaskDialog()):"next"===e&&(e=r.history[r.history.length-1],r.nextStep===e?r.step=r.history.pop():(r.history.push(r.step),r.step=r.nextStep),w.setupAddTaskDialog())},promiseWorkingOn:function(e){return w.disablePrevNext(!0),e.fail(function(e){o.find(".modal-body #dialog-errorbox").length||o.find(".modal-body").append(d('<div class="alert alert-danger" id="dialog-errorbox"></div>')),o.find(".modal-body #dialog-errorbox").text("Error: "+e).show()}).always(w.reactivatePrevNextButtons)},abortUpload:function(e,t){e&&"pending"===e.state()&&e.reject(t),window.jqXHR&&window.jqXHR.abort&&window.jqXHR.abort()},initUpload:function(){var n;window.jqXHR=o.find("#fileupload").fileupload({dataType:"json",formData:{_csrf_token:p},maxChunkSize:4<<20,sequentialUploads:!0}).on("fileuploadadd",function(e,t){window.jqXHR=t.submit(),n=d.Deferred(),w.promiseWorkingOn(n.promise()),o.find("#src-url").hide(),o.find("#src-uploading").show(),o.find("#upload-abort").off().click(function(){w.abortUpload(n,"Upload aborted.")})}).on("fileuploadchunkdone",function(e,t){t.result.filekey&&(t.formData.filekey=t.result.filekey),"Continue"===t.result.result?t.result.offset!==t.uploadedBytes&&w.abortUpload(n,"Unexpected offset! Expected: "+t.uploadedBytes+" Returned: "+t.result.offset):t.result.error?w.abortUpload(n,t.result.error):w.abortUpload()}).on("fileuploadprogressall",function(e,t){w.setProgressBar(o.find("#upload-progress"),t.loaded/t.total*100)}).on("fileuploadalways",function(e,t){delete t.formData.filekey,w.reactivatePrevNextButtons(),o.find("#src-url").show(),o.find("#src-uploading").hide()}).on("fileuploadfail",function(){w.abortUpload(n,"Something went wrong while uploading... try again?")}).on("fileuploaddone",function(e,t){var a;"Success"===t.result.result?(a="uploads:"+t.result.filekey,r.uploadedFile[a]=t.files[0],o.find("#url").val(a),n.resolve()):w.abortUpload(n,"Upload does not seem to be successful.")})},askAPI:function(e,t,n,i=null){null==i&&(i=r);var o=d.Deferred();return w.apiPost(e,t).done(function(e){if(e.error)o.reject(e.error);else{for(var t=0;t<n.length;t++){var a=n[t];s&&s[a]?i[a]=s[a]:e[a]&&(i[a]=e[a])}o.resolve(e)}}).fail(function(){o.reject("Something weird happened. Please try again.")}),o.promise()},apiPost:function(e,t){return t._csrf_token=p,d.post("api/"+e,t)},runWithConcurrency(e,t=5){let a=e.slice(),n=d.Deferred(),i=[],o=0,r=0,s=()=>{if(r>=a.length&&0===o)n.resolve(i);else for(;o<t&&r<a.length;){let t=r++;var e=a[t];o++,e().then(e=>{i[t]=e}).fail(e=>{i[t]={error:e}}).always(()=>{o--,s()})}};return s(),n.promise()}};d(document).ready(function(){w.init()})})(jQuery);