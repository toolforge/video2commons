(s=>{var o,r,l,i,n,d=window.config,c=window.i18n,t='<img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32">',e="rtl"===c["@dir"],u={abortbutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-remove"></span> '+nunjucks.lib.escape(c.abort)+"</button>",removebutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right remove-btn"><span class="glyphicon glyphicon-trash"></span> '+nunjucks.lib.escape(c.remove)+"</button>",restartbutton:'<button type="button" class="btn btn-xs flip pull-right restart-btn"><span class="glyphicon glyphicon-repeat"></span> '+nunjucks.lib.escape(c.restart)+"</button>",loading:"<center>"+t+"&nbsp;&nbsp;"+nunjucks.lib.escape(c.loading)+"</center>",errorDisconnect:'<div class="alert alert-danger">'+nunjucks.lib.escape(c.errorDisconnect)+"</div>",yourTasks:"<h4>"+nunjucks.lib.escape(c.yourTasks)+'</h4><table id="tasktable" class="table"><colgroup><col style="width: 20%;"/><col style="width: 10%;"/><col style="width: 40%;"/><col style="width: 30%;"/></colgroup><tbody></tbody></table>',workers:"<h4>"+nunjucks.lib.escape(c.workers)+"</h4>",capacity:e?`<div><span id="capacity">...</span> ${c.capacity}</div>`:`<div>${c.capacity} <span id="capacity">...</span></div>`,utilization:e?`<div><span id="utilization">...</span> ${c.utilization}</div>`:`<div>${c.utilization} <span id="utilization">...</span></div>`,pending:e?`<div><span id="pending">...</span> ${c.pending}</div>`:`<div>${c.pending} <span id="pending">...</span></div>`,addTask:'<input class="btn btn-primary btn-md" type="button" accesskey="n" value="'+nunjucks.lib.escape(c.addTask)+'">',requestServerSide:'<a class="btn btn-primary btn-success btn-md flip pull-right disabled" id="ssubtn">'+nunjucks.lib.escape(c.createServerSide)+"</a>",progressbar:'<div class="progress"><div class="progress-bar" role="progressbar"></div></div>',prevbutton:'<span class="glyphicon glyphicon-chevron-'+(e?"right":"left")+'"></span> '+nunjucks.lib.escape(c.back),nextbutton:nunjucks.lib.escape(c.next)+' <span class="glyphicon glyphicon-chevron-'+(e?"left":"right")+'"></span>',confirmbutton:nunjucks.lib.escape(c.confirm)},g="",p=(new nunjucks.Environment).addGlobal("config",d).addGlobal("_",function(e){return c[e]}).addFilter("process_link",function(e){for(var a,t=/\{\{#a\}\}(.*?)\{\{\/a\}\}/g,i=0,n="";null!==(a=t.exec(e));)n=(n+=nunjucks.lib.escape(e.substring(i,a.index)))+(e=>{if("#"===e[0]){var a=e.indexOf("|");if(a<0){if(/^[a-z0-9-]+$/i.test(e.slice(1)))return'<a id="'+e.slice(1)+'"></a>'}else if(/^[a-z0-9-]+$/i.test(e.substring(1,a)))return'<a id="'+e.substring(1,a)+'">'+nunjucks.lib.escape(e.slice(a+1))+"</a>"}return"<a>"+nunjucks.lib.escape(e)+"</a>"})(a[1]),i=t.lastIndex;return n+=nunjucks.lib.escape(e.slice(i)),new nunjucks.runtime.SafeString(n)});function b(e,a){var t,i,n,o;return a?!e.video&&e.audio?(t=(e=a).match(/^Audio files of (\d{4})$/))?(t=parseInt(t[1],10),(new Date).getFullYear()<t?{valid:!1,error:"The year must not be in the future."}:{valid:!0,value:e}):{valid:!1,error:c["datecategory-audio-error-format"]}:(e=(t=a).match(/^Videos of (\d{4})$/))?(e=parseInt(e[1],10),(new Date).getFullYear()<e?{valid:!1,error:c["datecategory-error-future-year"]}:{valid:!0,value:t}):(e=t.match(/^Videos taken on (\d{4})-(\d{2})-(\d{2})$/))?(a=parseInt(e[1],10),i=parseInt(e[2],10),e=parseInt(e[3],10),n=new Date(a,i-1,e),o=new Date,n.getFullYear()!==a||n.getMonth()!==i-1||n.getDate()!==e||o<n?{valid:!1,error:c["datecategory-error-invalid-date"]}:{valid:!0,value:t}):{valid:!1,error:c["datecategory-video-error-format"]}:{valid:!0,value:null}}function f(e){return(e.audio&&!e.video?h:y)(e)[0]}function y(e){var a=(new Date).toISOString().split("T")[0],e=e.date||a;return["Videos of "+e.split("-")[0],"Videos taken on "+e]}function h(e){var a=(new Date).toISOString().split("T")[0];return["Audio files of "+(e.date||a).split("-")[0]]}let m={getSourceData:function(){return{url:o.find("#url").val(),video:o.find("#video").is(":checked"),audio:o.find("#audio").is(":checked"),subtitles:o.find("#subtitles").is(":checked")}},getTargetData:function(){return{filename:o.find("#filename").val().trim(),format:o.find("#format").val(),filedesc:o.find("#filedesc").val(),dateCategory:o.find("#dateCategory").val().trim(),languageCategory:o.find("#languageCategory").val()||""}},getPlaylistData:function(){let a=[];return o.find(".video-select:checked").each(function(){var e=parseInt(s(this).val(),10),e=r.videos[e];a.push(e)}),a}},v={startTask:function(e){return V.apiPost("task/run",e)},updateFormats:function(e,a,t){return 0<t.formats.length&&e===t.video&&a===t.audio?s.when():V.askAPI("listformats",{video:e,audio:a},["video","audio","format","formats"])},updateUrl:function(a){var e;return a?a===r.url&&r.initialFilenameValidated?s.when():(e=r.uploadedFile[a])?(r.url=a,V.askAPI("makedesc",{filename:e.name||""},["extractor","filedesc","filename"])):V.askAPI("validateurl",{url:a},["entity_url"]).then(function(e){return e.entity_url?s.Deferred().reject("This video has already been uploaded: "+e.entity_url).promise():V.askAPI("extracturl",{url:a},["type","id","title","url","date","extractor","filedesc","filename","videos"]).then(()=>{r.initialFilenameValidated=!0})}).then(function(){"playlist"===r.type?r.videos.forEach(e=>{e.format=r.format,e.dateCategory=f(e)}):r.dateCategory=f(r)}):s.Deferred().reject("URL cannot be empty!").promise()},updateFilename:function(e,a=null){return null==a&&(a=r),e?e===a.filename&&a.initialFilenameValidated?s.when():V.askAPI("validatefilename",{filename:e},[],a).then(function(){return V.askAPI("validatefilenameunique",{filename:e},["filename"],a)}).then(function(){a.initialFilenameValidated=!0}):s.Deferred().reject("Filename cannot be empty!").promise()},updateFiledesc:function(e,a=null){return null==a&&(a=r),e?e===a.filedesc&&a.initialFiledescValidated?s.when():V.askAPI("validatefiledesc",{filedesc:e},["filedesc"],a).then(function(){a.initialFiledescValidated=!0}):s.Deferred().reject("Decription cannot be empty!").promise()},validateUrl:function(e){return V.askAPI("validateurl",{url:e},[]).then(e=>{if(e.entity_url)return s.Deferred().reject("This video has already been uploaded: "+e.entity_url).promise()})}},k={source:function(){var e=m.getSourceData();return oldTaskData={...r},r={...r,...e,selectedVideos:[]},s.when(v.updateFormats(e.video,e.audio,oldTaskData),v.updateUrl(e.url)).then(()=>{"playlist"===r.type?r.nextStep="playlist":r.nextStep="target"})},playlist:function(){let a=m.getPlaylistData();var e;return 0===a.length?s.Deferred().reject("Please select at least one video to upload!").promise():(e=[...a.map(e=>()=>v.updateFilename(e.filename,e)),...a.map(e=>()=>v.updateFiledesc(e.filedesc,e)),...a.map(e=>()=>v.validateUrl(e.url))],s.when(V.runWithConcurrency(e)).then(e=>{e=e.filter(e=>!!e?.error);if(0<e.length)return s.Deferred().reject(e.map(e=>e.error).join("\n\n")).promise();r.selectedVideos=a,r.nextStep="confirm"}))},target:function(){var e=m.getTargetData(),a="playlist"===r.type?r.videos[r.editingVideoIndex]:r,t=(a.format=e.format,b(a,e.dateCategory));return t.valid?(a.dateCategory=t.value,a.languageCategory=e.languageCategory||null,s.when(v.updateFilename(e.filename,a),v.updateFiledesc(e.filedesc,a)).then(()=>{"playlist"===r.type?r.nextStep="playlist":r.nextStep="confirm"})):s.Deferred().reject(t.error).promise()},confirm:function(){return s.when().then(()=>{r.nextStep=null})}};var V=window.video2commons={init:function(){s("#content").html(u.loading),i={},V.loadCsrf(V.checkStatus),s(window).on("beforeunload",function(e){if(o&&o.is(":visible"))return e.preventDefault(),e.returnValue=""});var e=/^#?!(https?:\/\/.+)/;e.test(window.location.hash)?V.addTask({url:window.location.hash.match(e)[1]}):window.location.search.slice(1)&&(l=Qs.parse(window.location.search.slice(1)),V.addTask({url:l.url}))},loadCsrf:function(a){s.get("api/csrf").done(function(e){g=e.csrf,a()})},checkStatus:function(){d.socketio_uri&&window.WebSocket&&window.io?V.checkStatusSocket():V.checkStatusLegacy()},checkStatusSocket:function(){var e,a,t;window.socket||(a=(e=d.socketio_uri.match(/^((?:(?:https?:)?\/\/)?[^/]+)(\/.*)$/))[1],(t=window.socket=io(a,{path:e[2]})).on("connect",function(){s.get("api/iosession").done(function(e){t.emit("auth",{iosession:e.iosession,_csrf_token:g})})}),t.on("status",function(e){V.alterTaskTableBoilerplate(function(){V.populateResults(e)})}),t.on("update",function(e,a){V.alterTaskTableBoilerplate(function(){V.updateTask(a)})}),t.on("remove",function(e){V.alterTaskTableBoilerplate(function(){s("#task-"+e).remove()})}))},checkStatusLegacy:function(){window.lastStatusCheck&&clearTimeout(window.lastStatusCheck);s.get("api/status").done(function(e){V.alterTaskTableBoilerplate(function(){V.populateResults(e)}),window.lastStatusCheck=setTimeout(V.checkStatusLegacy,5e3)}).fail(function(){s("#content").html(u.errorDisconnect)})},setupTables:function(){s("#content").empty(),s("#content").append(u.workers),s("#content").append(u.capacity),s("#content").append(u.utilization),s("#content").append(u.pending),s("#content").append(u.yourTasks);var e=s(u.addTask),e=(s("#content").append(e),e.click(function(){V.addTask()}),s(u.requestServerSide));s("#content").append(e.hide())},alterTaskTableBoilerplate:function(e){s("#tasktable").length||V.setupTables();var a=window.innerHeight+window.scrollY>=document.body.offsetHeight;e(),s.isEmptyObject(i)?s("#ssubtn").addClass("disabled").hide():s("#ssubtn").removeClass("disabled").show().attr("href",V.makeSSULink(i)),a&&window.scrollTo(0,document.body.scrollHeight)},populateResults:function(e){n=e.username;var a=s("#tasktable > tbody"),t=[];s.each(e.values,function(e,a){V.updateTask(a),t.push(a.id)}),a.find("> tr").each(function(){var e=s(this),a=V.getTaskIDFromDOMID(e.attr("id"));t.indexOf(a)<0&&e.remove()}),e.stats?(s("#capacity").text(e.stats.processing+" / "+e.stats.capacity),s("#utilization").text(Math.round(100*e.stats.utilization)+"%"),s("#pending").text(""+e.stats.pending)):(s("#capacity").text("N/A"),s("#utilization").text("N/A"),s("#pending").text("N/A"))},updateTask:function(e){function a(e,a,t){var i=o.find("#"+n+"-statustext");a?(a=i.html(e).find("a").attr("href",a),t&&a.text(t)):i.text()!==e&&i.text(e)}var t=s("#tasktable > tbody"),n="task-"+e.id,o=s("#"+n),t=(o.length?o.attr("status")!==e.status&&(o.html(""),V.setupTaskRow(o,n,e.status)):(s("#task-new").remove(),(o=s("<tr />")).attr({id:n,status:e.status}),t.append(o),V.setupTaskRow(o,n,e.status)),o.find("#"+n+"-title")),t=(t.text()!==e.title&&t.text(e.title),o.find("#"+n+"-hostname"));t.text()!==e.hostname&&t.text(e.hostname??"N/A");"done"===e.status?a(p.getFilter("process_link")(c.taskDone).toString(),e.url.replace("%3A",":"),e.text):"needssu"===e.status?a(p.getFilter("process_link")(c.errorTooLarge).toString(),V.makeSSULink([e])):"fail"===e.status?(a(e.text,e.url,e.url),e.restartable?o.find("#"+n+"-restartbutton").show().off().click(function(){V.eventTask(this,"restart")}):o.find("#"+n+"-restartbutton").off().hide()):a(e.text),"progress"===e.status&&V.setProgressBar(o.find("#"+n+"-progress"),e.progress),"needssu"===e.status?i[e.id]=e:delete i[e.id]},setupTaskRow:function(e,a,t){switch(t){case"progress":e.append(s("<td />").attr("id",a+"-title")).append(s("<td />").attr("id",a+"-hostname")).append(s("<td />").attr("id",a+"-status").append(s("<span />").attr("id",a+"-statustext"))).append(s("<td />").attr("id",a+"-progress"));var i=V.eventButton(a,"abort"),i=(e.find("#"+a+"-status").append(i),e.find("#"+a+"-progress").html(u.progressbar));V.setProgressBar(i,-1),e.removeClass("success danger");break;case"done":V.appendButtons([V.eventButton(a,"remove")],e,["danger","success"],a);break;case"fail":var i=V.eventButton(a,"remove"),n=V.eventButton(a,"restart").hide();V.appendButtons([i,n],e,["success","danger"],a);break;case"needssu":V.appendButtons([V.eventButton(a,"remove")],e,["success","danger"],a);break;case"abort":V.appendButtons([],e,["success","danger"],a)}e.attr("status",t)},makeSSULink:function(e){var a=s.map(e,function(e){return"* "+e.url}).join("\n"),e=s.map(e,function(e){return"| "+e.filename+" | "+e.hashsum+" |"}).join("\n");return"https://phabricator.wikimedia.org/maniphest/task/edit/form/106/?"+s.param({title:"Server side upload for "+n,projects:"video2commons,server-side-upload-request",description:"Please upload these file(s) to Wikimedia Commons:\n\n**URLs**\n\n{{{ urls }}}\n\n//Description files are available too: append `.txt` to the URLs.//\n\n**Checksums**\n\n| **File** | **MD5** |\n{{{ checksums }}}\n\nThank you!".replace("{{{ urls }}}",a).replace("{{{ checksums }}}",e)})},setProgressBar:function(e,a){e=e.find(".progress-bar");a<0?(e.addClass("progress-bar-striped active").addClass("active").text(""),a=100):e.removeClass("progress-bar-striped active").text(Math.round(a)+"%"),e.attr({"aria-valuenow":a,"aria-valuemin":"0","aria-valuemax":"100",style:"width:"+a+"%"})},getTaskIDFromDOMID:function(e){return/^(?:task-)?(.+?)(?:-(?:title|statustext|progress|abortbutton|removebutton|restartbutton))?$/.exec(e)[1]},eventTask:function(e,a){e=s(e);e.is(".disabled")||(e.off().addClass("disabled"),V.apiPost("task/"+a,{id:V.getTaskIDFromDOMID(e.attr("id"))}).done(function(e){e.error&&window.alert(e.error),V.checkStatus()}))},setText:function(e,a){for(var t=0;t<e.length;t++)o.find("#"+e[t]).text(a[e[t]])},eventButton:function(e,a){return s(u[a+"button"]).attr("id",e+"-"+a+"button").off().click(function(){V.eventTask(this,a)})},appendButtons:function(e,a,t,i){a.append(s("<td />").attr("id",i+"-title"));var n=s("<td />").attr("id",i+"-status").attr("colspan","3").append(s("<span />").attr("id",i+"-statustext"));e.length&&n.append(e[0]);for(var o=1;o<e.length;o++)n.append(e[o]);a.append(n).removeClass(t[0]).addClass(t[1])},addTask:function(e){o||((o=s("<div>").html(p.render("addTask.html"))).addClass("modal fade").attr({id:"addTaskDialog",role:"dialog"}),s("body").append(o),o.find("#btn-prev").html(u.prevbutton),o.find("#btn-next").html(u.nextbutton),o.find("#btn-cancel").click(function(){V.abortUpload()}),o.find(".modal-body").keypress(function(e){13!==(e.which||e.keyCode)||s(":focus").is("textarea")||(o.find(".modal-footer #btn-next").click(),e.preventDefault())})),V.openTaskModal(e)},openTaskModal:function(e){o.find("#dialog-spinner").hide(),o.find(".modal-body").html("<center>"+t+"</center>"),V.newTask(e),o.modal({backdrop:"static"}),o.on("shown.bs.modal",function(){o.find("#url").focus()}),V.reactivatePrevNextButtons()},newTask:function(e){r={step:"source",url:"",date:"",extractor:"",audio:!0,video:!0,subtitles:!0,filename:!0,formats:[],format:"",filedesc:"",dateCategory:"",languageCategory:"",uploadedFile:{},initialUrlValidated:!1,initialFilenameValidated:!1,initialFiledescValidated:!1,nextStep:"source",history:[],videos:[],selectedVideos:[],editingVideoIndex:null},s.extend(r,e),V.setupAddTaskDialog()},setupAddTaskDialog:function(){switch(r.step){case"source":o.find(".modal-body").html(p.render("sourceForm.html")),o.find("a#fl").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Acceptable_licenses"),o.find("a#pd").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Material_in_the_public_domain"),o.find("a#fu").attr("href","//commons.wikimedia.org/wiki/Commons:FU"),o.find("#url").val(r.url).on("input",function(){r.url!==s(this).val()&&(r.url=s(this).val());r.url.match(/(https?:\/\/)?(www\.)?(youtube|youtu|youtube-nocookie)\.(com|be)\/(watch\?.*?(?=v=)v=|embed\/|v\/|.+\?v=)?([^&=%\?]{11})/)?o.find("#youtube-warning").removeClass("hidden"):o.find("#youtube-warning").addClass("hidden")}).focus(),o.find("#video").prop("checked",r.video),o.find("#audio").prop("checked",r.audio),o.find("#subtitles").prop("checked",r.subtitles),V.initUpload();break;case"playlist":o.find(".modal-body").html(p.render("playlistForm.html",{task:r})),o.find(".video-select").each((e,a)=>{e=r.videos[e];0<=r.selectedVideos.indexOf(e)&&s(a).prop("checked",!0)});var e=o.find(".video-select:checked").length===o.find(".video-select").length;o.find("#select-all").prop("checked",e),o.find("#select-all").off().change(function(){var e=s(this).is(":checked");o.find(".video-select").prop("checked",e)}),o.find(".video-select").off().change(function(){var e=o.find(".video-select:checked").length===o.find(".video-select").length;o.find("#select-all").prop("checked",e)}),o.find(".btn-edit").off().click(function(){var e=s(this).data("video-index");r.selectedVideos=m.getPlaylistData(),r.editingVideoIndex=e,r.history.push(r.step),r.step="target",V.setupAddTaskDialog(),V.reactivatePrevNextButtons()});break;case"target":let a="playlist"===r.type?r.videos[r.editingVideoIndex]:r;o.find(".modal-body").html(p.render("targetForm.html",{source:a})),o.find("#filename").val(a.filename.trim()).focus(),s.each(r.formats,function(e,a){o.find("#format").append(s("<option></option>").text(a))}),o.find("#format").val(a.format),o.find("#filedesc").val(a.filedesc),o.find("#dateCategory").attr("placeholder",(e=a,t=(new Date).toISOString().split("T")[0],i=(t=e.date||t).split("-")[0],n=(e=e.audio&&!e.video)?c["datecategory-audio-placeholder"]:c["datecategory-video-placeholder"],e?n.replace("$1",i):n.replace("$1",i).replace("$2",t))).val(a.dateCategory||"");i=((n=a).audio&&!n.video?h:y)(n);s.each(i,function(e,a){o.find("#dateCategoryOptions").append(s("<option></option>").val(a))}),o.find("#dateCategory").on("input",function(){var e=b(a,s(this).val().trim());e.valid?(o.find("#dateCategoryError").hide(),o.find("#dateCategory-group").removeClass("has-error")):(o.find("#dateCategoryError").text(e.error).show(),o.find("#dateCategory-group").addClass("has-error"))}),r.video&&r.audio?(o.find("#languageCategory-group").show(),w.forEach(e=>{o.find("#languageCategory").append(s("<option></option>").val(e.category).text(e.label))}),a.languageCategory&&o.find("#languageCategory").val(a.languageCategory)):o.find("#languageCategory-group").hide();break;case"confirm":t="playlist"===r.type?p.render("playlistConfirmForm.html",{task:r}):p.render("confirmForm.html"),n=(o.find(".modal-body").html(t),[]);r.video&&n.push(c.video),r.audio&&n.push(c.audio),r.subtitles&&n.push(c.subtitles),o.find("#keep").text(n.join(", ")),V.setText(["url","extractor","filename","format"],r),o.find("#filedesc").val(r.filedesc),o.find("#btn-next").focus()}var t,i,n},reactivatePrevNextButtons:function(){switch(o.find("#dialog-spinner").hide(),r.step){case"source":o.find("#btn-prev").addClass("disabled").off(),o.find("#btn-next").html(u.nextbutton),V.setPrevNextButton("next");break;case"playlist":V.setPrevNextButton("prev"),o.find("#btn-next").html(u.nextbutton),V.setPrevNextButton("next");break;case"target":V.setPrevNextButton("prev"),"playlist"===r.type?o.find("#btn-next").html(u.confirmbutton):o.find("#btn-next").html(u.nextbutton),V.setPrevNextButton("next");break;case"confirm":V.setPrevNextButton("prev"),o.find("#btn-next").removeClass("disabled").html(u.confirmbutton).off().click(function(){V.disablePrevNext(!1),o.modal("hide"),s("#tasktable > tbody").append('<tr id="task-new"><td colspan="3">'+t+"</td></tr>"),window.scrollTo(0,document.body.scrollHeight),r.uploadedFile={};let a=[];if("playlist"===r.type)a=r.selectedVideos.map(e=>{let a=e.filedesc;return e.dateCategory&&(a+="\n[[Category:"+e.dateCategory+"]]"),e.languageCategory&&(a+="\n[[Category:"+e.languageCategory+"]]"),{url:e.url,extractor:e.extractor,subtitles:r.subtitles,filename:e.filename,filedesc:a,format:e.format}});else{let e=r.filedesc;r.dateCategory&&(e+="\n[[Category:"+r.dateCategory+"]]"),r.languageCategory&&(e+="\n[[Category:"+r.languageCategory+"]]"),a.push({url:r.url,extractor:r.extractor,subtitles:r.subtitles,filename:r.filename,filedesc:e,format:r.format})}V.runWithConcurrency(a.map(e=>()=>v.startTask(e).done(e=>{e.error&&window.alert(e.error)}))).always(()=>{V.checkStatus()})})}},setPrevNextButton:function(e){o.find("#btn-"+e).removeClass("disabled").off().click(function(){V.processInput(e)})},disablePrevNext:function(e){o.find(".modal-body #dialog-errorbox").hide(),o.find("#btn-prev").addClass("disabled").off(),o.find("#btn-next").addClass("disabled").off(),e&&o.find("#dialog-spinner").show()},processInput:function(e){var a=r.step,t=k[a];t?"next"===e?(t=t(),V.promiseWorkingOn(t.done(function(){V.transitionStep(e)}))):(V.transitionStep(e),V.reactivatePrevNextButtons()):console.error("Unknown step:",a)},transitionStep:function(e){"prev"===e&&0<r.history.length?(r.step=r.history.pop(),V.setupAddTaskDialog()):"next"===e&&(e=r.history[r.history.length-1],r.nextStep===e?r.step=r.history.pop():(r.history.push(r.step),r.step=r.nextStep),V.setupAddTaskDialog())},promiseWorkingOn:function(e){return V.disablePrevNext(!0),e.fail(function(e){o.find(".modal-body #dialog-errorbox").length||o.find(".modal-body").append(s('<div class="alert alert-danger" id="dialog-errorbox"></div>')),o.find(".modal-body #dialog-errorbox").text("Error: "+e).show()}).always(V.reactivatePrevNextButtons)},abortUpload:function(e,a){e&&"pending"===e.state()&&e.reject(a),window.jqXHR&&window.jqXHR.abort&&window.jqXHR.abort()},initUpload:function(){var i;window.jqXHR=o.find("#fileupload").fileupload({dataType:"json",formData:{_csrf_token:g},maxChunkSize:4<<20,sequentialUploads:!0}).on("fileuploadadd",function(e,a){window.jqXHR=a.submit(),i=s.Deferred(),V.promiseWorkingOn(i.promise()),o.find("#src-url").hide(),o.find("#src-uploading").show(),o.find("#upload-abort").off().click(function(){V.abortUpload(i,"Upload aborted.")})}).on("fileuploadchunkdone",function(e,a){a.result.filekey&&(a.formData.filekey=a.result.filekey),"Continue"===a.result.result?a.result.offset!==a.uploadedBytes&&V.abortUpload(i,"Unexpected offset! Expected: "+a.uploadedBytes+" Returned: "+a.result.offset):a.result.error?V.abortUpload(i,a.result.error):V.abortUpload()}).on("fileuploadprogressall",function(e,a){V.setProgressBar(o.find("#upload-progress"),a.loaded/a.total*100)}).on("fileuploadalways",function(e,a){delete a.formData.filekey,V.reactivatePrevNextButtons(),o.find("#src-url").show(),o.find("#src-uploading").hide()}).on("fileuploadfail",function(){V.abortUpload(i,"Something went wrong while uploading... try again?")}).on("fileuploaddone",function(e,a){var t;"Success"===a.result.result?(t="uploads:"+a.result.filekey,r.uploadedFile[t]=a.files[0],o.find("#url").val(t),i.resolve()):V.abortUpload(i,"Upload does not seem to be successful.")})},askAPI:function(e,a,i,n=null){null==n&&(n=r);var o=s.Deferred();return V.apiPost(e,a).done(function(e){if(e.error)o.reject(e.error);else{for(var a=0;a<i.length;a++){var t=i[a];l&&l[t]?n[t]=l[t]:e[t]&&(n[t]=e[t])}o.resolve(e)}}).fail(function(){o.reject("Something weird happened. Please try again.")}),o.promise()},apiPost:function(e,a){return a._csrf_token=g,s.post("api/"+e,a)},runWithConcurrency(e,a=5){let t=e.slice(),i=s.Deferred(),n=[],o=0,r=0,l=()=>{if(r>=t.length&&0===o)i.resolve(n);else for(;o<a&&r<t.length;){let a=r++;var e=t[a];o++,e().then(e=>{n[a]=e}).fail(e=>{n[a]={error:e}}).always(()=>{o--,l()})}};return l(),i.promise()}};let w=[{label:"Unselected",category:""},{label:"English (en)",category:"Videos in English"},{label:"American English (en-US)",category:"Videos in American English"},{label:"Australian English (en-AU)",category:"Videos in Australian English"},{label:"British English (en-GB)",category:"Videos in British English"},{label:"Canadian English (en-CA)",category:"Videos in Canadian English"},{label:"Spanish (es)",category:"Videos in Spanish"},{label:"Portuguese (pt)",category:"Videos in Portuguese"},{label:"Brazilian Portuguese (pt-BR)",category:"Videos in Brazilian Portuguese"},{label:"Chinese (zh)",category:"Videos in Chinese"},{label:"Cantonese (yue)",category:"Videos in Cantonese"},{label:"Mandarin (cmn)",category:"Videos in Mandarin"},{label:"Japanese (ja)",category:"Videos in Japanese"},{label:"Korean (ko)",category:"Videos in Korean"},{label:"Hindi (hi)",category:"Videos in Hindi"},{label:"Arabic (ar)",category:"Videos in Arabic"},{label:"Russian (ru)",category:"Videos in Russian"},{label:"German (de)",category:"Videos in German"},{label:"Bavarian (bar)",category:"Videos in Bavarian"},{label:"French (fr)",category:"Videos in French"},{label:"Italian (it)",category:"Videos in Italian"},{label:"Dutch (nl)",category:"Videos in Dutch"},{label:"Polish (pl)",category:"Videos in Polish"},{label:"Turkish (tr)",category:"Videos in Turkish"},{label:"Albanian (sq)",category:"Videos in Albanian"},{label:"Algerian Arabic (arq)",category:"Videos in Algerian Arabic"},{label:"Egyptian Arabic (arz)",category:"Videos in Egyptian Arabic"},{label:"Moroccan Arabic (ary)",category:"Videos in Moroccan Arabic"},{label:"North Levantine Arabic (apc)",category:"Videos in North Levantine Arabic"},{label:"Amharic (am)",category:"Videos in Amharic"},{label:"American Sign Language (ase)",category:"Videos in American Sign Language"},{label:"Ancient Greek (grc)",category:"Videos in Ancient Greek"},{label:"Armenian (hy)",category:"Videos in Armenian"},{label:"Assamese (as)",category:"Videos in Assamese"},{label:"Asturian (ast)",category:"Videos in Asturian"},{label:"Avar (av)",category:"Videos in Avar"},{label:"Azerbaijani (az)",category:"Videos in Azerbaijani"},{label:"Balinese (ban)",category:"Videos in Balinese"},{label:"Balochi (bal)",category:"Videos in Balochi"},{label:"Bangla (bn)",category:"Videos in Bangla"},{label:"Basque (eu)",category:"Videos in Basque"},{label:"Belarusian (be)",category:"Videos in Belarusian"},{label:"Bislama (bi)",category:"Videos in Bislama"},{label:"Bosnian (bs)",category:"Videos in Bosnian"},{label:"Breton (br)",category:"Videos in Breton"},{label:"British Sign Language (bfi)",category:"Videos in British Sign Language"},{label:"Bulgarian (bg)",category:"Videos in Bulgarian"},{label:"Burmese (my)",category:"Videos in Burmese"},{label:"Catalan (ca)",category:"Videos in Catalan"},{label:"Cebuano (ceb)",category:"Videos in Cebuano"},{label:"Central Bikol (bcl)",category:"Videos in Central Bikol"},{label:"Chamorro (ch)",category:"Videos in Chamorro"},{label:"Cherokee (chr)",category:"Videos in Cherokee"},{label:"Cornish (kw)",category:"Videos in Cornish"},{label:"Crimean Tatar (crh)",category:"Videos in Crimean Tatar"},{label:"Croatian (hr)",category:"Videos in Croatian"},{label:"Czech (cs)",category:"Videos in Czech"},{label:"Danish (da)",category:"Videos in Danish"},{label:"Dari (prs)",category:"Videos in Dari"},{label:"Esperanto (eo)",category:"Videos in Esperanto"},{label:"Estonian (et)",category:"Videos in Estonian"},{label:"Farsi (fa)",category:"Videos in Farsi"},{label:"Fijian (fj)",category:"Videos in Fijian"},{label:"Finnish (fi)",category:"Videos in Finnish"},{label:"Galician (gl)",category:"Videos in Galician"},{label:"Georgian (ka)",category:"Videos in Georgian"},{label:"Greek (el)",category:"Videos in Greek"},{label:"Greenlandic (kl)",category:"Videos in Greenlandic"},{label:"Guarani (gn)",category:"Videos in Guarani"},{label:"Gujarati (gu)",category:"Videos in Gujarati"},{label:"Haitian Creole (ht)",category:"Videos in Haitian Creole"},{label:"Hakka (hak)",category:"Videos in Hakka"},{label:"Min Dong Chinese (cdo)",category:"Videos in Min Dong Chinese"},{label:"Traditional Chinese, Taiwan (zh-Hant-TW)",category:"Videos in Traditional Chinese (Taiwan)"},{label:"Hausa (ha)",category:"Videos in Hausa"},{label:"Hebrew (he)",category:"Videos in Hebrew"},{label:"Hungarian (hu)",category:"Videos in Hungarian"},{label:"Icelandic (is)",category:"Videos in Icelandic"},{label:"Ido (io)",category:"Videos in Ido"},{label:"Igbo (ig)",category:"Videos in Igbo"},{label:"Indonesian (id)",category:"Videos in Indonesian"},{label:"Irish (ga)",category:"Videos in Irish"},{label:"Jamaican Patois (jam)",category:"Videos in Jamaican Patois"},{label:"Javanese (jv)",category:"Videos in Javanese"},{label:"Judaeo-Spanish (lad)",category:"Videos in Judaeo-Spanish"},{label:"Kannada (kn)",category:"Videos in Kannada"},{label:"Kashmiri (ks)",category:"Videos in Kashmiri"},{label:"Kazakh (kk)",category:"Videos in Kazakh"},{label:"Khasi (kha)",category:"Videos in Khasi"},{label:"Khmer (km)",category:"Videos in Khmer"},{label:"Komi (kv)",category:"Videos in Komi"},{label:"Kotava (avk)",category:"Videos in Kotava"},{label:"Kurdish (ku)",category:"Videos in Kurdish"},{label:"Kyrgyz (ky)",category:"Videos in Kyrgyz"},{label:"K'iche' (quc)",category:"Videos in K'iche'"},{label:"Lakota (lkt)",category:"Videos in Lakota"},{label:"Lao (lo)",category:"Videos in Lao"},{label:"Latin (la)",category:"Videos in Latin"},{label:"Latvian (lv)",category:"Videos in Latvian"},{label:"Leonese (roa-leon)",category:"Videos in Leonese"},{label:"Limburgish (li)",category:"Videos in Limburgish"},{label:"Lithuanian (lt)",category:"Videos in Lithuanian"},{label:"Lojban (jbo)",category:"Videos in Lojban"},{label:"Low German (nds)",category:"Videos in Low German"},{label:"Lozi (loz)",category:"Videos in Lozi"},{label:"Luxembourgish (lb)",category:"Videos in Luxembourgish"},{label:"Macedonian (mk)",category:"Videos in Macedonian"},{label:"Malay (ms)",category:"Videos in Malay"},{label:"Malayalam (ml)",category:"Videos in Malayalam"},{label:"Maltese (mt)",category:"Videos in Maltese"},{label:"Manx (gv)",category:"Videos in Manx"},{label:"Mapudungun (arn)",category:"Videos in Mapudungun"},{label:"Marathi (mr)",category:"Videos in Marathi"},{label:"Marwari (mwr)",category:"Videos in Marwari"},{label:"Mirandese (mwl)",category:"Videos in Mirandese"},{label:"Mongolian (mn)",category:"Videos in Mongolian"},{label:"Mossi (mos)",category:"Videos in Mossi"},{label:"Neapolitan (nap)",category:"Videos in Neapolitan"},{label:"Sicilian (scn)",category:"Videos in Sicilian"},{label:"Nepali (ne)",category:"Videos in Nepali"},{label:"Northern Sami (se)",category:"Videos in Northern Sami"},{label:"Norwegian (no)",category:"Videos in Norwegian"},{label:"Occitan (oc)",category:"Videos in Occitan"},{label:"Odia (or)",category:"Videos in Odia"},{label:"Pashto (ps)",category:"Videos in Pashto"},{label:"Punjabi (pa)",category:"Videos in Punjabi"},{label:"Quechua (qu)",category:"Videos in Quechua"},{label:"Romanian (ro)",category:"Videos in Romanian"},{label:"Saint Lucian Creole (acf)",category:"Videos in Saint Lucian Creole"},{label:"Samoan (sm)",category:"Videos in Samoan"},{label:"Sanskrit (sa)",category:"Videos in Sanskrit"},{label:"Santali (sat)",category:"Videos in Santali"},{label:"Sardinian (sc)",category:"Videos in Sardinian"},{label:"Serbian (sr)",category:"Videos in Serbian"},{label:"Serbian Cyrillic (sr-Cyrl)",category:"Videos in Serbian Cyrillic"},{label:"Serbo-Croatian (sh)",category:"Videos in Serbo-Croatian"},{label:"Silesian (szl)",category:"Videos in Silesian"},{label:"Sindhi (sd)",category:"Videos in Sindhi"},{label:"Slovak (sk)",category:"Videos in Slovak"},{label:"Slovene (sl)",category:"Videos in Slovene"},{label:"Somali (so)",category:"Videos in Somali"},{label:"Swahili (sw)",category:"Videos in Swahili"},{label:"Swedish (sv)",category:"Videos in Swedish"},{label:"Sylheti (syl)",category:"Videos in Sylheti"},{label:"Tagalog (tl)",category:"Videos in Tagalog"},{label:"Tamazight (zgh)",category:"Videos in Tamazight"},{label:"Tamil (ta)",category:"Videos in Tamil"},{label:"Tatar (tt)",category:"Videos in Tatar"},{label:"Telugu (te)",category:"Videos in Telugu"},{label:"Tetum (tet)",category:"Videos in Tetum"},{label:"Thai (th)",category:"Videos in Thai"},{label:"Tok Pisin (tpi)",category:"Videos in Tok Pisin"},{label:"Toki Pona (tok)",category:"Videos in Toki Pona"},{label:"Tsonga (ts)",category:"Videos in Tsonga"},{label:"Tuvan (tyv)",category:"Videos in Tuvan"},{label:"Twi (tw)",category:"Videos in Twi"},{label:"Ukrainian (uk)",category:"Videos in Ukrainian"},{label:"Urdu (ur)",category:"Videos in Urdu"},{label:"Veps (vep)",category:"Videos in Veps"},{label:"Vietnamese (vi)",category:"Videos in Vietnamese"},{label:"Volapük (vo)",category:"Videos in Volapük"},{label:"Walloon (wa)",category:"Videos in Walloon"},{label:"Welsh (cy)",category:"Videos in Welsh"},{label:"West Frisian (fy)",category:"Videos in West Frisian"},{label:"Wolof (wo)",category:"Videos in Wolof"},{label:"Xhosa (xh)",category:"Videos in Xhosa"},{label:"Yiddish (yi)",category:"Videos in Yiddish"},{label:"Yoruba (yo)",category:"Videos in Yoruba"},{label:"Yucatec (yua)",category:"Videos in Yucatec"}];s(document).ready(function(){V.init()})})(jQuery);