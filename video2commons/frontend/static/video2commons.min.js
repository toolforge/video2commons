(l=>{var i,o,r,a,s,d=window.config,c=window.i18n,t='<img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32">',e="rtl"===c["@dir"],u={abortbutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-remove"></span> '+nunjucks.lib.escape(c.abort)+"</button>",removebutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right remove-btn"><span class="glyphicon glyphicon-trash"></span> '+nunjucks.lib.escape(c.remove)+"</button>",restartbutton:'<button type="button" class="btn btn-xs flip pull-right restart-btn"><span class="glyphicon glyphicon-repeat"></span> '+nunjucks.lib.escape(c.restart)+"</button>",loading:"<center>"+t+"&nbsp;&nbsp;"+nunjucks.lib.escape(c.loading)+"</center>",errorDisconnect:'<div class="alert alert-danger">'+nunjucks.lib.escape(c.errorDisconnect)+"</div>",yourTasks:"<h4>"+nunjucks.lib.escape(c.yourTasks)+'</h4><table id="tasktable" class="table"><colgroup><col style="width: 20%;"/><col style="width: 10%;"/><col style="width: 40%;"/><col style="width: 30%;"/></colgroup><tbody></tbody></table>',workers:"<h4>"+nunjucks.lib.escape(c.workers)+"</h4>",capacity:e?`<div><span id="capacity">...</span> ${c.capacity}</div>`:`<div>${c.capacity} <span id="capacity">...</span></div>`,utilization:e?`<div><span id="utilization">...</span> ${c.utilization}</div>`:`<div>${c.utilization} <span id="utilization">...</span></div>`,pending:e?`<div><span id="pending">...</span> ${c.pending}</div>`:`<div>${c.pending} <span id="pending">...</span></div>`,addTask:'<input class="btn btn-primary btn-md" type="button" accesskey="n" value="'+nunjucks.lib.escape(c.addTask)+'">',requestServerSide:'<a class="btn btn-primary btn-success btn-md flip pull-right disabled" id="ssubtn">'+nunjucks.lib.escape(c.createServerSide)+"</a>",progressbar:'<div class="progress"><div class="progress-bar" role="progressbar"></div></div>',prevbutton:'<span class="glyphicon glyphicon-chevron-'+(e?"right":"left")+'"></span> '+nunjucks.lib.escape(c.back),nextbutton:nunjucks.lib.escape(c.next)+' <span class="glyphicon glyphicon-chevron-'+(e?"left":"right")+'"></span>',confirmbutton:nunjucks.lib.escape(c.confirm)},p="",f=(new nunjucks.Environment).addGlobal("config",d).addGlobal("_",function(e){return c[e]}).addFilter("process_link",function(e){for(var t,n=/\{\{#a\}\}(.*?)\{\{\/a\}\}/g,a=0,i="";null!==(t=n.exec(e));)i=(i+=nunjucks.lib.escape(e.substring(a,t.index)))+(e=>{if("#"===e[0]){var t=e.indexOf("|");if(t<0){if(/^[a-z0-9-]+$/i.test(e.slice(1)))return'<a id="'+e.slice(1)+'"></a>'}else if(/^[a-z0-9-]+$/i.test(e.substring(1,t)))return'<a id="'+e.substring(1,t)+'">'+nunjucks.lib.escape(e.slice(t+1))+"</a>"}return"<a>"+nunjucks.lib.escape(e)+"</a>"})(t[1]),a=n.lastIndex;return i+=nunjucks.lib.escape(e.slice(a)),new nunjucks.runtime.SafeString(i)});let n={getSourceData:function(){return{url:i.find("#url").val(),video:i.find("#video").is(":checked"),audio:i.find("#audio").is(":checked"),subtitles:i.find("#subtitles").is(":checked")}},getTargetData:function(){return{filename:i.find("#filename").val().trim(),format:i.find("#format").val(),filedesc:i.find("#filedesc").val()}},getPlaylistData:function(){let t=[];return i.find(".video-select:checked").each(function(){var e=parseInt(l(this).val(),10),e=o.videos[e];t.push(e)}),t}},h={startTask:function(e){return b.apiPost("task/run",e)},updateFormats:function(e,t){return 0<o.formats.length&&e===o.video&&t===o.audio?l.when():b.askAPI("listformats",{video:e,audio:t},["video","audio","format","formats"])},updateUrl:function(t){var e;return t?t===o.url&&o.initialFilenameValidated?l.when():(e=o.uploadedFile[t])?(o.url=t,b.askAPI("makedesc",{filename:e.name||""},["extractor","filedesc","filename"])):b.askAPI("validateurl",{url:t},["entity_url"]).then(function(e){return e.entity_url?l.Deferred().reject("This video has already been uploaded: "+e.entity_url).promise():b.askAPI("extracturl",{url:t},["type","id","title","url","extractor","filedesc","filename","videos"]).then(()=>{o.initialFilenameValidated=!0})}).then(function(){"playlist"===o.type&&o.videos.forEach(e=>{e.format=o.format})}):l.Deferred().reject("URL cannot be empty!").promise()},updateFilename:function(e,t=null){return null==t&&(t=o),e?e===t.filename&&t.initialFilenameValidated?l.when():b.askAPI("validatefilename",{filename:e},[],t).then(function(){return b.askAPI("validatefilenameunique",{filename:e},["filename"],t)}).then(function(){t.initialFilenameValidated=!0}):l.Deferred().reject("Filename cannot be empty!").promise()},updateFiledesc:function(e,t=null){return null==t&&(t=o),e?e===t.filedesc&&t.initialFiledescValidated?l.when():b.askAPI("validatefiledesc",{filedesc:e},["filedesc"],t).then(function(){t.initialFiledescValidated=!0}):l.Deferred().reject("Decription cannot be empty!").promise()},validateUrl:function(e){return b.askAPI("validateurl",{url:e},[]).then(e=>{if(e.entity_url)return l.Deferred().reject("This video has already been uploaded: "+e.entity_url).promise()})}},m={source:function(){var e=n.getSourceData();return o.subtitles=e.subtitles,o.selectedVideos=[],l.when(h.updateFormats(e.video,e.audio),h.updateUrl(e.url)).then(()=>{"playlist"===o.type?o.nextStep="playlist":o.nextStep="target"})},playlist:function(){let t=n.getPlaylistData();var e;return 0===t.length?l.Deferred().reject("Please select at least one video to upload!").promise():(e=[...t.map(e=>()=>h.updateFilename(e.filename,e)),...t.map(e=>()=>h.updateFiledesc(e.filedesc,e)),...t.map(e=>()=>h.validateUrl(e.url))],l.when(b.runWithConcurrency(e)).then(e=>{e=e.filter(e=>!!e?.error);if(0<e.length)return l.Deferred().reject(e.map(e=>e.error).join("\n\n")).promise();o.selectedVideos=t,o.nextStep="confirm"}))},target:function(){var e=n.getTargetData(),t="playlist"===o.type?o.videos[o.editingVideoIndex]:o;return t.format=e.format,l.when(h.updateFilename(e.filename,t),h.updateFiledesc(e.filedesc,t)).then(()=>{"playlist"===o.type?o.nextStep="playlist":o.nextStep="confirm"})},confirm:function(){return l.when().then(()=>{o.nextStep=null})}};var b=window.video2commons={init:function(){l("#content").html(u.loading),a={},b.loadCsrf(b.checkStatus),l(window).on("beforeunload",function(e){if(i&&i.is(":visible"))return e.preventDefault(),e.returnValue=""});var e=/^#?!(https?:\/\/.+)/;e.test(window.location.hash)?b.addTask({url:window.location.hash.match(e)[1]}):window.location.search.slice(1)&&(r=Qs.parse(window.location.search.slice(1)),b.addTask({url:r.url}))},loadCsrf:function(t){l.get("api/csrf").done(function(e){p=e.csrf,t()})},checkStatus:function(){d.socketio_uri&&window.WebSocket&&window.io?b.checkStatusSocket():b.checkStatusLegacy()},checkStatusSocket:function(){var e,t,n;window.socket||(t=(e=d.socketio_uri.match(/^((?:(?:https?:)?\/\/)?[^/]+)(\/.*)$/))[1],(n=window.socket=io(t,{path:e[2]})).on("connect",function(){l.get("api/iosession").done(function(e){n.emit("auth",{iosession:e.iosession,_csrf_token:p})})}),n.on("status",function(e){b.alterTaskTableBoilerplate(function(){b.populateResults(e)})}),n.on("update",function(e,t){b.alterTaskTableBoilerplate(function(){b.updateTask(t)})}),n.on("remove",function(e){b.alterTaskTableBoilerplate(function(){l("#task-"+e).remove()})}))},checkStatusLegacy:function(){window.lastStatusCheck&&clearTimeout(window.lastStatusCheck);l.get("api/status").done(function(e){b.alterTaskTableBoilerplate(function(){b.populateResults(e)}),window.lastStatusCheck=setTimeout(b.checkStatusLegacy,5e3)}).fail(function(){l("#content").html(u.errorDisconnect)})},setupTables:function(){l("#content").empty(),l("#content").append(u.workers),l("#content").append(u.capacity),l("#content").append(u.utilization),l("#content").append(u.pending),l("#content").append(u.yourTasks);var e=l(u.addTask),e=(l("#content").append(e),e.click(function(){b.addTask()}),l(u.requestServerSide));l("#content").append(e.hide())},alterTaskTableBoilerplate:function(e){l("#tasktable").length||b.setupTables();var t=window.innerHeight+window.scrollY>=document.body.offsetHeight;e(),l.isEmptyObject(a)?l("#ssubtn").addClass("disabled").hide():l("#ssubtn").removeClass("disabled").show().attr("href",b.makeSSULink(a)),t&&window.scrollTo(0,document.body.scrollHeight)},populateResults:function(e){s=e.username;var t=l("#tasktable > tbody"),n=[];l.each(e.values,function(e,t){b.updateTask(t),n.push(t.id)}),t.find("> tr").each(function(){var e=l(this),t=b.getTaskIDFromDOMID(e.attr("id"));n.indexOf(t)<0&&e.remove()}),e.stats?(l("#capacity").text(e.stats.processing+" / "+e.stats.capacity),l("#utilization").text(Math.round(100*e.stats.utilization)+"%"),l("#pending").text(""+e.stats.pending)):(l("#capacity").text("N/A"),l("#utilization").text("N/A"),l("#pending").text("N/A"))},updateTask:function(e){function t(e,t,n){var a=s.find("#"+i+"-statustext");t?(t=a.html(e).find("a").attr("href",t),n&&t.text(n)):a.text()!==e&&a.text(e)}var n=l("#tasktable > tbody"),i="task-"+e.id,s=l("#"+i),n=(s.length?s.attr("status")!==e.status&&(s.html(""),b.setupTaskRow(s,i,e.status)):(l("#task-new").remove(),(s=l("<tr />")).attr({id:i,status:e.status}),n.append(s),b.setupTaskRow(s,i,e.status)),s.find("#"+i+"-title")),n=(n.text()!==e.title&&n.text(e.title),s.find("#"+i+"-hostname"));n.text()!==e.hostname&&n.text(e.hostname??"N/A");"done"===e.status?t(f.getFilter("process_link")(c.taskDone).toString(),e.url.replace("%3A",":"),e.text):"needssu"===e.status?t(f.getFilter("process_link")(c.errorTooLarge).toString(),b.makeSSULink([e])):"fail"===e.status?(t(e.text,e.url,e.url),e.restartable?s.find("#"+i+"-restartbutton").show().off().click(function(){b.eventTask(this,"restart")}):s.find("#"+i+"-restartbutton").off().hide()):t(e.text),"progress"===e.status&&b.setProgressBar(s.find("#"+i+"-progress"),e.progress),"needssu"===e.status?a[e.id]=e:delete a[e.id]},setupTaskRow:function(e,t,n){switch(n){case"progress":e.append(l("<td />").attr("id",t+"-title")).append(l("<td />").attr("id",t+"-hostname")).append(l("<td />").attr("id",t+"-status").append(l("<span />").attr("id",t+"-statustext"))).append(l("<td />").attr("id",t+"-progress"));var a=b.eventButton(t,"abort"),a=(e.find("#"+t+"-status").append(a),e.find("#"+t+"-progress").html(u.progressbar));b.setProgressBar(a,-1),e.removeClass("success danger");break;case"done":b.appendButtons([b.eventButton(t,"remove")],e,["danger","success"],t);break;case"fail":var a=b.eventButton(t,"remove"),i=b.eventButton(t,"restart").hide();b.appendButtons([a,i],e,["success","danger"],t);break;case"needssu":b.appendButtons([b.eventButton(t,"remove")],e,["success","danger"],t);break;case"abort":b.appendButtons([],e,["success","danger"],t)}e.attr("status",n)},makeSSULink:function(e){var t=l.map(e,function(e){return"* "+e.url}).join("\n"),e=l.map(e,function(e){return"| "+e.filename+" | "+e.hashsum+" |"}).join("\n");return"https://phabricator.wikimedia.org/maniphest/task/edit/form/106/?"+l.param({title:"Server side upload for "+s,projects:"video2commons,server-side-upload-request",description:"Please upload these file(s) to Wikimedia Commons:\n\n**URLs**\n\n{{{ urls }}}\n\n//Description files are available too: append `.txt` to the URLs.//\n\n**Checksums**\n\n| **File** | **MD5** |\n{{{ checksums }}}\n\nThank you!".replace("{{{ urls }}}",t).replace("{{{ checksums }}}",e)})},setProgressBar:function(e,t){e=e.find(".progress-bar");t<0?(e.addClass("progress-bar-striped active").addClass("active").text(""),t=100):e.removeClass("progress-bar-striped active").text(Math.round(t)+"%"),e.attr({"aria-valuenow":t,"aria-valuemin":"0","aria-valuemax":"100",style:"width:"+t+"%"})},getTaskIDFromDOMID:function(e){return/^(?:task-)?(.+?)(?:-(?:title|statustext|progress|abortbutton|removebutton|restartbutton))?$/.exec(e)[1]},eventTask:function(e,t){e=l(e);e.is(".disabled")||(e.off().addClass("disabled"),b.apiPost("task/"+t,{id:b.getTaskIDFromDOMID(e.attr("id"))}).done(function(e){e.error&&window.alert(e.error),b.checkStatus()}))},setText:function(e,t){for(var n=0;n<e.length;n++)i.find("#"+e[n]).text(t[e[n]])},eventButton:function(e,t){return l(u[t+"button"]).attr("id",e+"-"+t+"button").off().click(function(){b.eventTask(this,t)})},appendButtons:function(e,t,n,a){t.append(l("<td />").attr("id",a+"-title"));var i=l("<td />").attr("id",a+"-status").attr("colspan","3").append(l("<span />").attr("id",a+"-statustext"));e.length&&i.append(e[0]);for(var s=1;s<e.length;s++)i.append(e[s]);t.append(i).removeClass(n[0]).addClass(n[1])},addTask:function(e){i||((i=l("<div>").html(f.render("addTask.html"))).addClass("modal fade").attr({id:"addTaskDialog",role:"dialog"}),l("body").append(i),i.find("#btn-prev").html(u.prevbutton),i.find("#btn-next").html(u.nextbutton),i.find("#btn-cancel").click(function(){b.abortUpload()}),i.find(".modal-body").keypress(function(e){13!==(e.which||e.keyCode)||l(":focus").is("textarea")||(i.find(".modal-footer #btn-next").click(),e.preventDefault())})),b.openTaskModal(e)},openTaskModal:function(e){i.find("#dialog-spinner").hide(),i.find(".modal-body").html("<center>"+t+"</center>"),b.newTask(e),i.modal({backdrop:"static"}),i.on("shown.bs.modal",function(){i.find("#url").focus()}),b.reactivatePrevNextButtons()},newTask:function(e){o={step:"source",url:"",extractor:"",audio:!0,video:!0,subtitles:!0,filename:!0,formats:[],format:"",filedesc:"",uploadedFile:{},initialUrlValidated:!1,initialFilenameValidated:!1,initialFiledescValidated:!1,nextStep:"source",history:[],videos:[],selectedVideos:[],editingVideoIndex:null},l.extend(o,e),b.setupAddTaskDialog()},setupAddTaskDialog:function(){switch(o.step){case"source":i.find(".modal-body").html(f.render("sourceForm.html")),i.find("a#fl").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Acceptable_licenses"),i.find("a#pd").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Material_in_the_public_domain"),i.find("a#fu").attr("href","//commons.wikimedia.org/wiki/Commons:FU"),i.find("#url").val(o.url).on("input",function(){o.url!==l(this).val()&&(o.url=l(this).val());o.url.match(/(https?:\/\/)?(www\.)?(youtube|youtu|youtube-nocookie)\.(com|be)\/(watch\?.*?(?=v=)v=|embed\/|v\/|.+\?v=)?([^&=%\?]{11})/)?i.find("#youtube-warning").removeClass("hidden"):i.find("#youtube-warning").addClass("hidden")}).focus(),i.find("#video").prop("checked",o.video),i.find("#audio").prop("checked",o.audio),i.find("#subtitles").prop("checked",o.subtitles),b.initUpload();break;case"playlist":i.find(".modal-body").html(f.render("playlistForm.html",{task:o})),i.find(".video-select").each((e,t)=>{e=o.videos[e];0<=o.selectedVideos.indexOf(e)&&l(t).prop("checked",!0)});var e=i.find(".video-select:checked").length===i.find(".video-select").length;i.find("#select-all").prop("checked",e),i.find("#select-all").off().change(function(){var e=l(this).is(":checked");i.find(".video-select").prop("checked",e)}),i.find(".video-select").off().change(function(){var e=i.find(".video-select:checked").length===i.find(".video-select").length;i.find("#select-all").prop("checked",e)}),i.find(".btn-edit").off().click(function(){var e=l(this).data("video-index");o.selectedVideos=n.getPlaylistData(),o.editingVideoIndex=e,o.history.push(o.step),o.step="target",b.setupAddTaskDialog(),b.reactivatePrevNextButtons()});break;case"target":e="playlist"===o.type?o.videos[o.editingVideoIndex]:o;i.find(".modal-body").html(f.render("targetForm.html")),i.find("#filename").val(e.filename.trim()).focus(),l.each(o.formats,function(e,t){i.find("#format").append(l("<option></option>").text(t))}),i.find("#format").val(e.format),i.find("#filedesc").val(e.filedesc);break;case"confirm":e="playlist"===o.type?f.render("playlistConfirmForm.html",{task:o}):f.render("confirmForm.html"),e=(i.find(".modal-body").html(e),[]);o.video&&e.push(c.video),o.audio&&e.push(c.audio),o.subtitles&&e.push(c.subtitles),i.find("#keep").text(e.join(", ")),b.setText(["url","extractor","filename","format"],o),i.find("#filedesc").val(o.filedesc),i.find("#btn-next").focus()}},reactivatePrevNextButtons:function(){switch(i.find("#dialog-spinner").hide(),o.step){case"source":i.find("#btn-prev").addClass("disabled").off(),i.find("#btn-next").html(u.nextbutton),b.setPrevNextButton("next");break;case"playlist":b.setPrevNextButton("prev"),i.find("#btn-next").html(u.nextbutton),b.setPrevNextButton("next");break;case"target":b.setPrevNextButton("prev"),"playlist"===o.type?i.find("#btn-next").html(u.confirmbutton):i.find("#btn-next").html(u.nextbutton),b.setPrevNextButton("next");break;case"confirm":b.setPrevNextButton("prev"),i.find("#btn-next").removeClass("disabled").html(u.confirmbutton).off().click(function(){b.disablePrevNext(!1),i.modal("hide"),l("#tasktable > tbody").append('<tr id="task-new"><td colspan="3">'+t+"</td></tr>"),window.scrollTo(0,document.body.scrollHeight),o.uploadedFile={};let e=[];"playlist"===o.type?e=o.selectedVideos.map(e=>({url:e.url,extractor:e.extractor,subtitles:o.subtitles,filename:e.filename,filedesc:e.filedesc,format:e.format})):e.push({url:o.url,extractor:o.extractor,subtitles:o.subtitles,filename:o.filename,filedesc:o.filedesc,format:o.format}),b.runWithConcurrency(e.map(e=>()=>h.startTask(e).done(e=>{e.error&&window.alert(e.error)}))).always(()=>{b.checkStatus()})})}},setPrevNextButton:function(e){i.find("#btn-"+e).removeClass("disabled").off().click(function(){b.processInput(e)})},disablePrevNext:function(e){i.find(".modal-body #dialog-errorbox").hide(),i.find("#btn-prev").addClass("disabled").off(),i.find("#btn-next").addClass("disabled").off(),e&&i.find("#dialog-spinner").show()},processInput:function(e){var t=o.step,n=m[t];n?"next"===e?(n=n(),b.promiseWorkingOn(n.done(function(){b.transitionStep(e)}))):(b.transitionStep(e),b.reactivatePrevNextButtons()):console.error("Unknown step:",t)},transitionStep:function(e){"prev"===e&&0<o.history.length?(o.step=o.history.pop(),b.setupAddTaskDialog()):"next"===e&&(e=o.history[o.history.length-1],o.nextStep===e?o.step=o.history.pop():(o.history.push(o.step),o.step=o.nextStep),b.setupAddTaskDialog())},promiseWorkingOn:function(e){return b.disablePrevNext(!0),e.fail(function(e){i.find(".modal-body #dialog-errorbox").length||i.find(".modal-body").append(l('<div class="alert alert-danger" id="dialog-errorbox"></div>')),i.find(".modal-body #dialog-errorbox").text("Error: "+e).show()}).always(b.reactivatePrevNextButtons)},abortUpload:function(e,t){e&&"pending"===e.state()&&e.reject(t),window.jqXHR&&window.jqXHR.abort&&window.jqXHR.abort()},initUpload:function(){var a;window.jqXHR=i.find("#fileupload").fileupload({dataType:"json",formData:{_csrf_token:p},maxChunkSize:4<<20,sequentialUploads:!0}).on("fileuploadadd",function(e,t){window.jqXHR=t.submit(),a=l.Deferred(),b.promiseWorkingOn(a.promise()),i.find("#src-url").hide(),i.find("#src-uploading").show(),i.find("#upload-abort").off().click(function(){b.abortUpload(a,"Upload aborted.")})}).on("fileuploadchunkdone",function(e,t){t.result.filekey&&(t.formData.filekey=t.result.filekey),"Continue"===t.result.result?t.result.offset!==t.uploadedBytes&&b.abortUpload(a,"Unexpected offset! Expected: "+t.uploadedBytes+" Returned: "+t.result.offset):t.result.error?b.abortUpload(a,t.result.error):b.abortUpload()}).on("fileuploadprogressall",function(e,t){b.setProgressBar(i.find("#upload-progress"),t.loaded/t.total*100)}).on("fileuploadalways",function(e,t){delete t.formData.filekey,b.reactivatePrevNextButtons(),i.find("#src-url").show(),i.find("#src-uploading").hide()}).on("fileuploadfail",function(){b.abortUpload(a,"Something went wrong while uploading... try again?")}).on("fileuploaddone",function(e,t){var n;"Success"===t.result.result?(n="uploads:"+t.result.filekey,o.uploadedFile[n]=t.files[0],i.find("#url").val(n),a.resolve()):b.abortUpload(a,"Upload does not seem to be successful.")})},askAPI:function(e,t,a,i=null){null==i&&(i=o);var s=l.Deferred();return b.apiPost(e,t).done(function(e){if(e.error)s.reject(e.error);else{for(var t=0;t<a.length;t++){var n=a[t];r&&r[n]?i[n]=r[n]:e[n]&&(i[n]=e[n])}s.resolve(e)}}).fail(function(){s.reject("Something weird happened. Please try again.")}),s.promise()},apiPost:function(e,t){return t._csrf_token=p,l.post("api/"+e,t)},runWithConcurrency(e,t=5){let n=e.slice(),a=l.Deferred(),i=[],s=0,o=0,r=()=>{if(o>=n.length&&0===s)a.resolve(i);else for(;s<t&&o<n.length;){let t=o++;var e=n[t];s++,e().then(e=>{i[t]=e}).fail(e=>{i[t]={error:e}}).always(()=>{s--,r()})}};return r(),a.promise()}};l(document).ready(function(){b.init()})})(jQuery);