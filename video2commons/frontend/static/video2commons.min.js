(d=>{var r,s,o,a,i,n=window.config,l=window.i18n,c='<img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32">',e="rtl"===l["@dir"],u={abortbutton:`<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-remove"></span> ${nunjucks.lib.escape(l.abort)}</button>`,removebutton:`<button type="button" class="btn btn-danger btn-xs flip pull-right remove-btn"><span class="glyphicon glyphicon-trash"></span> ${nunjucks.lib.escape(l.remove)}</button>`,restartbutton:`<button type="button" class="btn btn-xs flip pull-right restart-btn"><span class="glyphicon glyphicon-repeat"></span> ${nunjucks.lib.escape(l.restart)}</button>`,loading:`<center>${c}&nbsp;&nbsp;${nunjucks.lib.escape(l.loading)}</center>`,errorDisconnect:`<div class="alert alert-danger">${nunjucks.lib.escape(l.errorDisconnect)}</div>`,yourTasks:`<h4>${nunjucks.lib.escape(l.yourTasks)}</h4><table id="tasktable" class="table"><colgroup><col style="width: 20%;"/><col style="width: 10%;"/><col style="width: 40%;"/><col style="width: 30%;"/></colgroup><tbody></tbody></table>`,workers:`<h4>${nunjucks.lib.escape(l.workers)}</h4>`,capacity:e?`<div><span id="capacity">...</span> ${l.capacity}</div>`:`<div>${l.capacity} <span id="capacity">...</span></div>`,utilization:e?`<div><span id="utilization">...</span> ${l.utilization}</div>`:`<div>${l.utilization} <span id="utilization">...</span></div>`,pending:e?`<div><span id="pending">...</span> ${l.pending}</div>`:`<div>${l.pending} <span id="pending">...</span></div>`,addTask:`<input class="btn btn-primary btn-md" type="button" accesskey="n" value="${nunjucks.lib.escape(l.addTask)}">`,requestServerSide:`<a class="btn btn-primary btn-success btn-md flip pull-right disabled" id="ssubtn">${nunjucks.lib.escape(l.createServerSide)}</a>`,progressbar:'<div class="progress"><div class="progress-bar" role="progressbar"></div></div>',prevbutton:`<span class="glyphicon glyphicon-chevron-${e?"right":"left"}"></span> `+nunjucks.lib.escape(l.back),nextbutton:nunjucks.lib.escape(l.next)+` <span class="glyphicon glyphicon-chevron-${e?"left":"right"}"></span>`,confirmbutton:nunjucks.lib.escape(l.confirm)},p="",f=(new nunjucks.Environment).addGlobal("config",n).addGlobal("_",e=>l[e]).addFilter("process_link",e=>{for(var t,a=/\{\{#a\}\}(.*?)\{\{\/a\}\}/g,i=0,n="";null!==(t=a.exec(e));)n=(n+=nunjucks.lib.escape(e.substring(i,t.index)))+(e=>{if("#"===e[0]){var t=e.indexOf("|");if(t<0){if(/^[a-z0-9-]+$/i.test(e.slice(1)))return`<a id="${e.slice(1)}"></a>`}else if(/^[a-z0-9-]+$/i.test(e.substring(1,t)))return`<a id="${e.substring(1,t)}">${nunjucks.lib.escape(e.slice(t+1))}</a>`}return`<a>${nunjucks.lib.escape(e)}</a>`})(t[1]),i=a.lastIndex;return n+=nunjucks.lib.escape(e.slice(i)),new nunjucks.runtime.SafeString(n)});function h(e,t){var a,i,n,r;return t?!e.video&&e.audio?(a=(e=t).match(/^Audio files of (\d{4})$/))?(a=parseInt(a[1],10),(new Date).getFullYear()<a?{valid:!1,error:"The year must not be in the future."}:{valid:!0,value:e}):{valid:!1,error:l["datecategory-audio-error-format"]}:(e=(a=t).match(/^Videos of (\d{4})$/))?(e=parseInt(e[1],10),(new Date).getFullYear()<e?{valid:!1,error:l["datecategory-error-future-year"]}:{valid:!0,value:a}):(e=a.match(/^Videos taken on (\d{4})-(\d{2})-(\d{2})$/))?(t=parseInt(e[1],10),i=parseInt(e[2],10),e=parseInt(e[3],10),n=new Date(t,i-1,e),r=new Date,n.getFullYear()!==t||n.getMonth()!==i-1||n.getDate()!==e||r<n?{valid:!1,error:l["datecategory-error-invalid-date"]}:{valid:!0,value:a}):{valid:!1,error:l["datecategory-video-error-format"]}:{valid:!0,value:null}}function m(e){return(e.audio&&!e.video?b:v)(e)[0]}function v(e){var t=(new Date).toISOString().split("T")[0],e=e.date||t;return["Videos of "+e.split("-")[0],"Videos taken on "+e]}function b(e){var t=(new Date).toISOString().split("T")[0];return["Audio files of "+(e.date||t).split("-")[0]]}let g={getSourceData:()=>({url:r.find("#url").val(),video:r.find("#video").is(":checked"),audio:r.find("#audio").is(":checked"),subtitles:r.find("#subtitles").is(":checked")}),getTargetData:()=>({filename:r.find("#filename").val().trim(),format:r.find("#format").val(),filedesc:r.find("#filedesc").val(),dateCategory:r.find("#dateCategory").val().trim()}),getPlaylistData:()=>{let t=[];return r.find(".video-select:checked").each(function(){var e=parseInt(d(this).val(),10),e=s.videos[e];t.push(e)}),t}},k={startTask:e=>w.apiPost("task/run",e),updateFormats:(e,t,a)=>0<a.formats.length&&e===a.video&&t===a.audio?d.when():w.askAPI("listformats",{video:e,audio:t},["video","audio","format","formats"]),updateUrl:t=>{var e;return t?t===s.url&&s.initialFilenameValidated?d.when():(e=s.uploadedFile[t])?(s.url=t,w.askAPI("makedesc",{filename:e.name||""},["extractor","filedesc","filename"])):w.askAPI("validateurl",{url:t},["entity_url"]).then(e=>e.entity_url?d.Deferred().reject("This video has already been uploaded: "+e.entity_url).promise():w.askAPI("extracturl",{url:t},["type","id","title","url","date","extractor","filedesc","filename","videos"]).then(()=>{s.initialFilenameValidated=!0})).then(()=>{"playlist"===s.type?s.videos.forEach(e=>{e.format=s.format,e.dateCategory=m(e)}):s.dateCategory=m(s)}):d.Deferred().reject("URL cannot be empty!").promise()},updateFilename:(e,t=null)=>(null==t&&(t=s),e?e===t.filename&&t.initialFilenameValidated?d.when():w.askAPI("validatefilename",{filename:e},[],t).then(()=>w.askAPI("validatefilenameunique",{filename:e},["filename"],t)).then(()=>{t.initialFilenameValidated=!0}):d.Deferred().reject("Filename cannot be empty!").promise()),updateFiledesc:(e,t=null)=>(null==t&&(t=s),e?e===t.filedesc&&t.initialFiledescValidated?d.when():w.askAPI("validatefiledesc",{filedesc:e},["filedesc"],t).then(()=>{t.initialFiledescValidated=!0}):d.Deferred().reject("Decription cannot be empty!").promise()),validateUrl:e=>w.askAPI("validateurl",{url:e},[]).then(e=>{if(e.entity_url)return d.Deferred().reject("This video has already been uploaded: "+e.entity_url).promise()})},y={source:()=>{var e=g.getSourceData();return oldTaskData={...s},s={...s,...e,selectedVideos:[]},d.when(k.updateFormats(e.video,e.audio,oldTaskData),k.updateUrl(e.url)).then(()=>{"playlist"===s.type?s.nextStep="playlist":s.nextStep="target"})},playlist:()=>{let t=g.getPlaylistData();var e;return 0===t.length?d.Deferred().reject("Please select at least one video to upload!").promise():(e=[...t.map(e=>()=>k.updateFilename(e.filename,e)),...t.map(e=>()=>k.updateFiledesc(e.filedesc,e)),...t.map(e=>()=>k.validateUrl(e.url))],d.when(w.runWithConcurrency(e)).then(e=>{e=e.filter(e=>!!e?.error);if(0<e.length)return d.Deferred().reject(e.map(e=>e.error).join("\n\n")).promise();s.selectedVideos=t,s.nextStep="confirm"}))},target:()=>{var e=g.getTargetData(),t="playlist"===s.type?s.videos[s.editingVideoIndex]:s,a=(t.format=e.format,h(t,e.dateCategory));return a.valid?(t.dateCategory=a.value,d.when(k.updateFilename(e.filename,t),k.updateFiledesc(e.filedesc,t)).then(()=>{"playlist"===s.type?s.nextStep="playlist":s.nextStep="confirm"})):d.Deferred().reject(a.error).promise()},confirm:()=>d.when().then(()=>{s.nextStep=null})};var w=window.video2commons={init:()=>{d("#content").html(u.loading),a={},w.loadCsrf(w.checkStatus),d(window).on("beforeunload",e=>{if(r?.is(":visible"))return e.preventDefault(),e.returnValue=""});var e=/^#?!(https?:\/\/.+)/;e.test(window.location.hash)?w.addTask({url:window.location.hash.match(e)[1]}):window.location.search.slice(1)&&(o=Qs.parse(window.location.search.slice(1)),w.addTask({url:o.url}))},loadCsrf:t=>{d.get("api/csrf").done(e=>{p=e.csrf,t()})},checkStatus:()=>{n.socketio_uri&&window.WebSocket&&window.io?w.checkStatusSocket():w.checkStatusLegacy()},checkStatusSocket:()=>{var e,t,a;window.socket||(t=(e=n.socketio_uri.match(/^((?:(?:https?:)?\/\/)?[^/]+)(\/.*)$/))[1],(a=window.socket=io(t,{path:e[2]})).on("connect",()=>{d.get("api/iosession").done(e=>{a.emit("auth",{iosession:e.iosession,_csrf_token:p})})}),a.on("status",e=>{w.alterTaskTableBoilerplate(()=>{w.populateResults(e)})}),a.on("update",(e,t)=>{w.alterTaskTableBoilerplate(()=>{w.updateTask(t)})}),a.on("remove",e=>{w.alterTaskTableBoilerplate(()=>{d("#task-"+e).remove()})}))},checkStatusLegacy:()=>{window.lastStatusCheck&&clearTimeout(window.lastStatusCheck);d.get("api/status").done(e=>{w.alterTaskTableBoilerplate(()=>{w.populateResults(e)}),window.lastStatusCheck=setTimeout(w.checkStatusLegacy,5e3)}).fail(()=>{d("#content").html(u.errorDisconnect)})},setupTables:()=>{d("#content").empty(),d("#content").append(u.workers),d("#content").append(u.capacity),d("#content").append(u.utilization),d("#content").append(u.pending),d("#content").append(u.yourTasks);var e=d(u.addTask),e=(d("#content").append(e),e.click(()=>{w.addTask()}),d(u.requestServerSide));d("#content").append(e.hide())},alterTaskTableBoilerplate:e=>{d("#tasktable").length||w.setupTables();var t=window.innerHeight+window.scrollY>=document.body.offsetHeight;e(),d.isEmptyObject(a)?d("#ssubtn").addClass("disabled").hide():d("#ssubtn").removeClass("disabled").show().attr("href",w.makeSSULink(a)),t&&window.scrollTo(0,document.body.scrollHeight)},populateResults:e=>{i=e.username;var t=d("#tasktable > tbody"),a=[];d.each(e.values,(e,t)=>{w.updateTask(t),a.push(t.id)}),t.find("> tr").each(function(){var e=d(this),t=w.getTaskIDFromDOMID(e.attr("id"));a.indexOf(t)<0&&e.remove()}),e.stats?(d("#capacity").text(e.stats.processing+" / "+e.stats.capacity),d("#utilization").text(Math.round(100*e.stats.utilization)+"%"),d("#pending").text(""+e.stats.pending)):(d("#capacity").text("N/A"),d("#utilization").text("N/A"),d("#pending").text("N/A"))},updateTask:e=>{var t=d("#tasktable > tbody"),n="task-"+e.id,r=d("#"+n),t=(r.length?r.attr("status")!==e.status&&(r.html(""),w.setupTaskRow(r,n,e.status)):(d("#task-new").remove(),(r=d("<tr />")).attr({id:n,status:e.status}),t.append(r),w.setupTaskRow(r,n,e.status)),r.find(`#${n}-title`)),t=(t.text()!==e.title&&t.text(e.title),r.find(`#${n}-hostname`)),t=(t.text()!==e.hostname&&t.text(e.hostname??"N/A"),(e,t,a)=>{var i=r.find(`#${n}-statustext`);t?(t=i.html(e).find("a").attr("href",t),a&&t.text(a)):i.text()!==e&&i.text(e)});"done"===e.status?t(f.getFilter("process_link")(l.taskDone).toString(),e.url.replace("%3A",":"),e.text):"needssu"===e.status?t(f.getFilter("process_link")(l.errorTooLarge).toString(),w.makeSSULink([e])):"fail"===e.status?(t(e.text,e.url,e.url),e.restartable?r.find(`#${n}-restartbutton`).show().off().click(function(){w.eventTask(this,"restart")}):r.find(`#${n}-restartbutton`).off().hide()):t(e.text),"progress"===e.status&&w.setProgressBar(r.find(`#${n}-progress`),e.progress),"needssu"===e.status?a[e.id]=e:delete a[e.id]},setupTaskRow:(e,t,a)=>{switch(a){case"progress":e.append(d("<td />").attr("id",t+"-title")).append(d("<td />").attr("id",t+"-hostname")).append(d("<td />").attr("id",t+"-status").append(d("<span />").attr("id",t+"-statustext"))).append(d("<td />").attr("id",t+"-progress"));var i=w.eventButton(t,"abort"),i=(e.find(`#${t}-status`).append(i),e.find(`#${t}-progress`).html(u.progressbar));w.setProgressBar(i,-1),e.removeClass("success danger");break;case"done":w.appendButtons([w.eventButton(t,"remove")],e,["danger","success"],t);break;case"fail":var i=w.eventButton(t,"remove"),n=w.eventButton(t,"restart").hide();w.appendButtons([i,n],e,["success","danger"],t);break;case"needssu":w.appendButtons([w.eventButton(t,"remove")],e,["success","danger"],t);break;case"abort":w.appendButtons([],e,["success","danger"],t)}e.attr("status",a)},makeSSULink:e=>{var t=d.map(e,e=>"* "+e.url).join("\n"),e=d.map(e,e=>`| ${e.filename} | ${e.hashsum} |`).join("\n");return"https://phabricator.wikimedia.org/maniphest/task/edit/form/106/?"+d.param({title:"Server side upload for "+i,projects:"video2commons,server-side-upload-request",description:"Please upload these file(s) to Wikimedia Commons:\n\n**URLs**\n\n{{{ urls }}}\n\n//Description files are available too: append `.txt` to the URLs.//\n\n**Checksums**\n\n| **File** | **MD5** |\n{{{ checksums }}}\n\nThank you!".replace("{{{ urls }}}",t).replace("{{{ checksums }}}",e)})},setProgressBar:(e,t)=>{e=e.find(".progress-bar");t<0?(e.addClass("progress-bar-striped active").addClass("active").text(""),t=100):e.removeClass("progress-bar-striped active").text(Math.round(t)+"%"),e.attr({"aria-valuenow":t,"aria-valuemin":"0","aria-valuemax":"100",style:`width:${t}%`})},getTaskIDFromDOMID:e=>/^(?:task-)?(.+?)(?:-(?:title|statustext|progress|abortbutton|removebutton|restartbutton))?$/.exec(e)[1],eventTask:(e,t)=>{e=d(e);e.is(".disabled")||(e.off().addClass("disabled"),w.apiPost("task/"+t,{id:w.getTaskIDFromDOMID(e.attr("id"))}).done(e=>{e.error&&window.alert(e.error),w.checkStatus()}))},setText:(e,t)=>{for(var a=0;a<e.length;a++)r.find("#"+e[a]).text(t[e[a]])},eventButton:(e,t)=>d(u[t+"button"]).attr("id",e+`-${t}button`).off().click(function(){w.eventTask(this,t)}),appendButtons:(e,t,a,i)=>{t.append(d("<td />").attr("id",i+"-title"));var n=d("<td />").attr("id",i+"-status").attr("colspan","3").append(d("<span />").attr("id",i+"-statustext"));e.length&&n.append(e[0]);for(var r=1;r<e.length;r++)n.append(e[r]);t.append(n).removeClass(a[0]).addClass(a[1])},addTask:e=>{r||((r=d("<div>").html(f.render("addTask.html"))).addClass("modal fade").attr({id:"addTaskDialog",role:"dialog"}),d("body").append(r),r.find("#btn-prev").html(u.prevbutton),r.find("#btn-next").html(u.nextbutton),r.find("#btn-cancel").click(()=>{w.abortUpload()}),r.find(".modal-body").keypress(e=>{13!==(e.which||e.keyCode)||d(":focus").is("textarea")||(r.find(".modal-footer #btn-next").click(),e.preventDefault())})),w.openTaskModal(e)},openTaskModal:e=>{r.find("#dialog-spinner").hide(),r.find(".modal-body").html(`<center>${c}</center>`),w.newTask(e),r.modal({backdrop:"static"}),r.on("shown.bs.modal",()=>{r.find("#url").focus()}),w.reactivatePrevNextButtons()},newTask:e=>{s={step:"source",url:"",date:"",extractor:"",audio:!0,video:!0,subtitles:!0,filename:!0,formats:[],format:"",filedesc:"",dateCategory:"",uploadedFile:{},initialUrlValidated:!1,initialFilenameValidated:!1,initialFiledescValidated:!1,nextStep:"source",history:[],videos:[],selectedVideos:[],editingVideoIndex:null},d.extend(s,e),w.setupAddTaskDialog()},setupAddTaskDialog:()=>{switch(s.step){case"source":r.find(".modal-body").html(f.render("sourceForm.html")),r.find("a#fl").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Acceptable_licenses"),r.find("a#pd").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Material_in_the_public_domain"),r.find("a#fu").attr("href","//commons.wikimedia.org/wiki/Commons:FU"),r.find("#url").val(s.url).on("input",function(){s.url!==d(this).val()&&(s.url=d(this).val());s.url.match(/(https?:\/\/)?(www\.)?(youtube|youtu|youtube-nocookie)\.(com|be)\/(watch\?.*?(?=v=)v=|embed\/|v\/|.+\?v=)?([^&=%?]{11})/)?r.find("#youtube-warning").removeClass("hidden"):r.find("#youtube-warning").addClass("hidden")}).focus(),r.find("#video").prop("checked",s.video),r.find("#audio").prop("checked",s.audio),r.find("#subtitles").prop("checked",s.subtitles),w.initUpload();break;case"playlist":r.find(".modal-body").html(f.render("playlistForm.html",{task:s})),r.find(".video-select").each((e,t)=>{e=s.videos[e];0<=s.selectedVideos.indexOf(e)&&d(t).prop("checked",!0)});var e=r.find(".video-select:checked").length===r.find(".video-select").length;r.find("#select-all").prop("checked",e),r.find("#select-all").off().change(function(){var e=d(this).is(":checked");r.find(".video-select").prop("checked",e)}),r.find(".video-select").off().change(()=>{var e=r.find(".video-select:checked").length===r.find(".video-select").length;r.find("#select-all").prop("checked",e)}),r.find(".btn-edit").off().click(function(){var e=d(this).data("video-index");s.selectedVideos=g.getPlaylistData(),s.editingVideoIndex=e,s.history.push(s.step),s.step="target",w.setupAddTaskDialog(),w.reactivatePrevNextButtons()});break;case"target":{let t="playlist"===s.type?s.videos[s.editingVideoIndex]:s;r.find(".modal-body").html(f.render("targetForm.html",{source:t})),r.find("#filename").val(t.filename.trim()).focus(),d.each(s.formats,(e,t)=>{r.find("#format").append(d("<option></option>").text(t))}),r.find("#format").val(t.format),r.find("#filedesc").val(t.filedesc),r.find("#dateCategory").attr("placeholder",(e=t,a=(new Date).toISOString().split("T")[0],i=(a=e.date||a).split("-")[0],n=(e=e.audio&&!e.video)?l["datecategory-audio-placeholder"]:l["datecategory-video-placeholder"],e?n.replace("$1",i):n.replace("$1",i).replace("$2",a))).val(t.dateCategory||"");i=((n=t).audio&&!n.video?b:v)(n);d.each(i,(e,t)=>{r.find("#dateCategoryOptions").append(d("<option></option>").val(t))}),r.find("#dateCategory").on("input",function(){var e=h(t,d(this).val().trim());e.valid?(r.find("#dateCategoryError").hide(),r.find("#dateCategory-group").removeClass("has-error")):(r.find("#dateCategoryError").text(e.error).show(),r.find("#dateCategory-group").addClass("has-error"))});break}case"confirm":a="playlist"===s.type?f.render("playlistConfirmForm.html",{task:s}):f.render("confirmForm.html"),n=(r.find(".modal-body").html(a),[]);s.video&&n.push(l.video),s.audio&&n.push(l.audio),s.subtitles&&n.push(l.subtitles),r.find("#keep").text(n.join(", ")),w.setText(["url","extractor","filename","format"],s),r.find("#filedesc").val(s.filedesc),r.find("#btn-next").focus()}var a,i,n},reactivatePrevNextButtons:()=>{switch(r.find("#dialog-spinner").hide(),s.step){case"source":r.find("#btn-prev").addClass("disabled").off(),r.find("#btn-next").html(u.nextbutton),w.setPrevNextButton("next");break;case"playlist":w.setPrevNextButton("prev"),r.find("#btn-next").html(u.nextbutton),w.setPrevNextButton("next");break;case"target":w.setPrevNextButton("prev"),"playlist"===s.type?r.find("#btn-next").html(u.confirmbutton):r.find("#btn-next").html(u.nextbutton),w.setPrevNextButton("next");break;case"confirm":w.setPrevNextButton("prev"),r.find("#btn-next").removeClass("disabled").html(u.confirmbutton).off().click(()=>{w.disablePrevNext(!1),r.modal("hide"),d("#tasktable > tbody").append(`<tr id="task-new"><td colspan="3">${c}</td></tr>`),window.scrollTo(0,document.body.scrollHeight),s.uploadedFile={};let t=[];if("playlist"===s.type)t=s.selectedVideos.map(e=>{let t=e.filedesc;return e.dateCategory&&(t+=`
[[Category:${e.dateCategory}]]`),{url:e.url,extractor:e.extractor,subtitles:s.subtitles,filename:e.filename,filedesc:t,format:e.format}});else{let e=s.filedesc;s.dateCategory&&(e+=`
[[Category:${s.dateCategory}]]`),t.push({url:s.url,extractor:s.extractor,subtitles:s.subtitles,filename:s.filename,filedesc:e,format:s.format})}w.runWithConcurrency(t.map(e=>()=>k.startTask(e).done(e=>{e.error&&window.alert(e.error)}))).always(()=>{w.checkStatus()})})}},setPrevNextButton:e=>{r.find("#btn-"+e).removeClass("disabled").off().click(()=>{w.processInput(e)})},disablePrevNext:e=>{r.find(".modal-body #dialog-errorbox").hide(),r.find("#btn-prev").addClass("disabled").off(),r.find("#btn-next").addClass("disabled").off(),e&&r.find("#dialog-spinner").show()},processInput:e=>{var t=s.step,a=y[t];a?"next"===e?(a=a(),w.promiseWorkingOn(a.done(()=>{w.transitionStep(e)}))):(w.transitionStep(e),w.reactivatePrevNextButtons()):console.error("Unknown step:",t)},transitionStep:e=>{"prev"===e&&0<s.history.length?(s.step=s.history.pop(),w.setupAddTaskDialog()):"next"===e&&(e=s.history[s.history.length-1],s.nextStep===e?s.step=s.history.pop():(s.history.push(s.step),s.step=s.nextStep),w.setupAddTaskDialog())},promiseWorkingOn:e=>(w.disablePrevNext(!0),e.fail(e=>{r.find(".modal-body #dialog-errorbox").length||r.find(".modal-body").append(d('<div class="alert alert-danger" id="dialog-errorbox"></div>')),r.find(".modal-body #dialog-errorbox").text("Error: "+e).show()}).always(w.reactivatePrevNextButtons)),abortUpload:(e,t)=>{e&&"pending"===e.state()&&e.reject(t),window.jqXHR?.abort&&window.jqXHR.abort()},initUpload:()=>{var i;window.jqXHR=r.find("#fileupload").fileupload({dataType:"json",formData:{_csrf_token:p},maxChunkSize:4<<20,sequentialUploads:!0}).on("fileuploadadd",(e,t)=>{window.jqXHR=t.submit(),i=d.Deferred(),w.promiseWorkingOn(i.promise()),r.find("#src-url").hide(),r.find("#src-uploading").show(),r.find("#upload-abort").off().click(()=>{w.abortUpload(i,"Upload aborted.")})}).on("fileuploadchunkdone",(e,t)=>{t.result.filekey&&(t.formData.filekey=t.result.filekey),"Continue"===t.result.result?t.result.offset!==t.uploadedBytes&&w.abortUpload(i,`Unexpected offset! Expected: ${t.uploadedBytes} Returned: `+t.result.offset):t.result.error?w.abortUpload(i,t.result.error):w.abortUpload()}).on("fileuploadprogressall",(e,t)=>{w.setProgressBar(r.find("#upload-progress"),t.loaded/t.total*100)}).on("fileuploadalways",(e,t)=>{delete t.formData.filekey,w.reactivatePrevNextButtons(),r.find("#src-url").show(),r.find("#src-uploading").hide()}).on("fileuploadfail",()=>{w.abortUpload(i,"Something went wrong while uploading... try again?")}).on("fileuploaddone",(e,t)=>{var a;"Success"===t.result.result?(a="uploads:"+t.result.filekey,s.uploadedFile[a]=t.files[0],r.find("#url").val(a),i.resolve()):w.abortUpload(i,"Upload does not seem to be successful.")})},askAPI:(e,t,i,n=null)=>{null==n&&(n=s);var r=d.Deferred();return w.apiPost(e,t).done(e=>{if(e.error)r.reject(e.error);else{for(var t=0;t<i.length;t++){var a=i[t];o?.[a]?n[a]=o[a]:e[a]&&(n[a]=e[a])}r.resolve(e)}}).fail(()=>{r.reject("Something weird happened. Please try again.")}),r.promise()},apiPost:(e,t)=>(t._csrf_token=p,d.post("api/"+e,t)),runWithConcurrency(e,t=5){let a=e.slice(),i=d.Deferred(),n=[],r=0,s=0,o=()=>{if(s>=a.length&&0===r)i.resolve(n);else for(;r<t&&s<a.length;){let t=s++;var e=a[t];r++,e().then(e=>{n[t]=e}).fail(e=>{n[t]={error:e}}).always(()=>{r--,o()})}};return o(),i.promise()}};d(document).ready(()=>{w.init()})})(jQuery);