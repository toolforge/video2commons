(s=>{var n,r,l,t,i,o=window.config,d=window.i18n,c='<img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32">',e="rtl"===d["@dir"],u={abortbutton:`<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-remove"></span> ${nunjucks.lib.escape(d.abort)}</button>`,removebutton:`<button type="button" class="btn btn-danger btn-xs flip pull-right remove-btn"><span class="glyphicon glyphicon-trash"></span> ${nunjucks.lib.escape(d.remove)}</button>`,restartbutton:`<button type="button" class="btn btn-xs flip pull-right restart-btn"><span class="glyphicon glyphicon-repeat"></span> ${nunjucks.lib.escape(d.restart)}</button>`,loading:`<center>${c}&nbsp;&nbsp;${nunjucks.lib.escape(d.loading)}</center>`,errorDisconnect:`<div class="alert alert-danger">${nunjucks.lib.escape(d.errorDisconnect)}</div>`,yourTasks:`<h4>${nunjucks.lib.escape(d.yourTasks)}</h4><table id="tasktable" class="table"><colgroup><col style="width: 20%;"/><col style="width: 10%;"/><col style="width: 40%;"/><col style="width: 30%;"/></colgroup><tbody></tbody></table>`,workers:`<h4>${nunjucks.lib.escape(d.workers)}</h4>`,capacity:e?`<div><span id="capacity">...</span> ${d.capacity}</div>`:`<div>${d.capacity} <span id="capacity">...</span></div>`,utilization:e?`<div><span id="utilization">...</span> ${d.utilization}</div>`:`<div>${d.utilization} <span id="utilization">...</span></div>`,pending:e?`<div><span id="pending">...</span> ${d.pending}</div>`:`<div>${d.pending} <span id="pending">...</span></div>`,addTask:`<input class="btn btn-primary btn-md" type="button" accesskey="n" value="${nunjucks.lib.escape(d.addTask)}">`,requestServerSide:`<a class="btn btn-primary btn-success btn-md flip pull-right disabled" id="ssubtn">${nunjucks.lib.escape(d.createServerSide)}</a>`,progressbar:'<div class="progress"><div class="progress-bar" role="progressbar"></div></div>',prevbutton:`<span class="glyphicon glyphicon-chevron-${e?"right":"left"}"></span> `+nunjucks.lib.escape(d.back),nextbutton:nunjucks.lib.escape(d.next)+` <span class="glyphicon glyphicon-chevron-${e?"left":"right"}"></span>`,confirmbutton:nunjucks.lib.escape(d.confirm)},g="",p=(new nunjucks.Environment).addGlobal("config",o).addGlobal("_",e=>d[e]).addFilter("process_link",e=>{for(var a,t=/\{\{#a\}\}(.*?)\{\{\/a\}\}/g,i=0,o="";null!==(a=t.exec(e));)o=(o+=nunjucks.lib.escape(e.substring(i,a.index)))+(e=>{if("#"===e[0]){var a=e.indexOf("|");if(a<0){if(/^[a-z0-9-]+$/i.test(e.slice(1)))return`<a id="${e.slice(1)}"></a>`}else if(/^[a-z0-9-]+$/i.test(e.substring(1,a)))return`<a id="${e.substring(1,a)}">${nunjucks.lib.escape(e.slice(a+1))}</a>`}return`<a>${nunjucks.lib.escape(e)}</a>`})(a[1]),i=t.lastIndex;return o+=nunjucks.lib.escape(e.slice(i)),new nunjucks.runtime.SafeString(o)});function b(e,a){var t,i,o,n;return a?!e.video&&e.audio?(t=(e=a).match(/^Audio files of (\d{4})$/))?(t=parseInt(t[1],10),(new Date).getFullYear()<t?{valid:!1,error:"The year must not be in the future."}:{valid:!0,value:e}):{valid:!1,error:d["datecategory-audio-error-format"]}:(e=(t=a).match(/^Videos of (\d{4})$/))?(e=parseInt(e[1],10),(new Date).getFullYear()<e?{valid:!1,error:d["datecategory-error-future-year"]}:{valid:!0,value:t}):(e=t.match(/^Videos taken on (\d{4})-(\d{2})-(\d{2})$/))?(a=parseInt(e[1],10),i=parseInt(e[2],10),e=parseInt(e[3],10),o=new Date(a,i-1,e),n=new Date,o.getFullYear()!==a||o.getMonth()!==i-1||o.getDate()!==e||n<o?{valid:!1,error:d["datecategory-error-invalid-date"]}:{valid:!0,value:t}):{valid:!1,error:d["datecategory-video-error-format"]}:{valid:!0,value:null}}function y(e){return(e.audio&&!e.video?f:h)(e)[0]}function h(e){var a=(new Date).toISOString().split("T")[0],e=e.date||a;return["Videos of "+e.split("-")[0],"Videos taken on "+e]}function f(e){var a=(new Date).toISOString().split("T")[0];return["Audio files of "+(e.date||a).split("-")[0]]}let m={getSourceData:()=>({url:n.find("#url").val(),video:n.find("#video").is(":checked"),audio:n.find("#audio").is(":checked"),subtitles:n.find("#subtitles").is(":checked")}),getTargetData:()=>({filename:n.find("#filename").val().trim(),format:n.find("#format").val(),filedesc:n.find("#filedesc").val(),dateCategory:n.find("#dateCategory").val().trim(),languageCategory:n.find("#languageCategory").val()||""}),getPlaylistData:()=>{let a=[];return n.find(".video-select:checked").each(function(){var e=parseInt(s(this).val(),10),e=r.videos[e];a.push(e)}),a}},v={startTask:e=>V.apiPost("task/run",e),updateFormats:(e,a,t)=>0<t.formats.length&&e===t.video&&a===t.audio?s.when():V.askAPI("listformats",{video:e,audio:a},["video","audio","format","formats"]),updateUrl:a=>{var e;return a?a===r.url&&r.initialFilenameValidated?s.when():(e=r.uploadedFile[a])?(r.url=a,V.askAPI("makedesc",{filename:e.name||""},["extractor","filedesc","filename"])):V.askAPI("validateurl",{url:a},["entity_url"]).then(e=>e.entity_url?s.Deferred().reject("This video has already been uploaded: "+e.entity_url).promise():V.askAPI("extracturl",{url:a},["type","id","title","url","date","extractor","filedesc","filename","videos"]).then(()=>{r.initialFilenameValidated=!0})).then(()=>{"playlist"===r.type?r.videos.forEach(e=>{e.format=r.format,e.dateCategory=y(e)}):r.dateCategory=y(r)}):s.Deferred().reject("URL cannot be empty!").promise()},updateFilename:(e,a=null)=>(null==a&&(a=r),e?e===a.filename&&a.initialFilenameValidated?s.when():V.askAPI("validatefilename",{filename:e},[],a).then(()=>V.askAPI("validatefilenameunique",{filename:e},["filename"],a)).then(()=>{a.initialFilenameValidated=!0}):s.Deferred().reject("Filename cannot be empty!").promise()),updateFiledesc:(e,a=null)=>(null==a&&(a=r),e?e===a.filedesc&&a.initialFiledescValidated?s.when():V.askAPI("validatefiledesc",{filedesc:e},["filedesc"],a).then(()=>{a.initialFiledescValidated=!0}):s.Deferred().reject("Decription cannot be empty!").promise()),validateUrl:e=>V.askAPI("validateurl",{url:e},[]).then(e=>{if(e.entity_url)return s.Deferred().reject("This video has already been uploaded: "+e.entity_url).promise()})},k={source:()=>{var e=m.getSourceData();return oldTaskData={...r},r={...r,...e,selectedVideos:[]},s.when(v.updateFormats(e.video,e.audio,oldTaskData),v.updateUrl(e.url)).then(()=>{"playlist"===r.type?r.nextStep="playlist":r.nextStep="target"})},playlist:()=>{let a=m.getPlaylistData();var e;return 0===a.length?s.Deferred().reject("Please select at least one video to upload!").promise():(e=[...a.map(e=>()=>v.updateFilename(e.filename,e)),...a.map(e=>()=>v.updateFiledesc(e.filedesc,e)),...a.map(e=>()=>v.validateUrl(e.url))],s.when(V.runWithConcurrency(e)).then(e=>{e=e.filter(e=>!!e?.error);if(0<e.length)return s.Deferred().reject(e.map(e=>e.error).join("\n\n")).promise();r.selectedVideos=a,r.nextStep="confirm"}))},target:()=>{var e=m.getTargetData(),a="playlist"===r.type?r.videos[r.editingVideoIndex]:r,t=(a.format=e.format,b(a,e.dateCategory));return t.valid?(a.dateCategory=t.value,a.languageCategory=e.languageCategory||null,s.when(v.updateFilename(e.filename,a),v.updateFiledesc(e.filedesc,a)).then(()=>{"playlist"===r.type?r.nextStep="playlist":r.nextStep="confirm"})):s.Deferred().reject(t.error).promise()},confirm:()=>s.when().then(()=>{r.nextStep=null})};var V=window.video2commons={init:()=>{s("#content").html(u.loading),t={},V.loadCsrf(V.checkStatus),s(window).on("beforeunload",e=>{if(n?.is(":visible"))return e.preventDefault(),e.returnValue=""});var e=/^#?!(https?:\/\/.+)/;e.test(window.location.hash)?V.addTask({url:window.location.hash.match(e)[1]}):window.location.search.slice(1)&&(l=Qs.parse(window.location.search.slice(1)),V.addTask({url:l.url}))},loadCsrf:a=>{s.get("api/csrf").done(e=>{g=e.csrf,a()})},checkStatus:()=>{o.socketio_uri&&window.WebSocket&&window.io?V.checkStatusSocket():V.checkStatusLegacy()},checkStatusSocket:()=>{var e,a,t;window.socket||(a=(e=o.socketio_uri.match(/^((?:(?:https?:)?\/\/)?[^/]+)(\/.*)$/))[1],(t=window.socket=io(a,{path:e[2]})).on("connect",()=>{s.get("api/iosession").done(e=>{t.emit("auth",{iosession:e.iosession,_csrf_token:g})})}),t.on("status",e=>{V.alterTaskTableBoilerplate(()=>{V.populateResults(e)})}),t.on("update",(e,a)=>{V.alterTaskTableBoilerplate(()=>{V.updateTask(a)})}),t.on("remove",e=>{V.alterTaskTableBoilerplate(()=>{s("#task-"+e).remove()})}))},checkStatusLegacy:()=>{window.lastStatusCheck&&clearTimeout(window.lastStatusCheck);s.get("api/status").done(e=>{V.alterTaskTableBoilerplate(()=>{V.populateResults(e)}),window.lastStatusCheck=setTimeout(V.checkStatusLegacy,5e3)}).fail(()=>{s("#content").html(u.errorDisconnect)})},setupTables:()=>{s("#content").empty(),s("#content").append(u.workers),s("#content").append(u.capacity),s("#content").append(u.utilization),s("#content").append(u.pending),s("#content").append(u.yourTasks);var e=s(u.addTask),e=(s("#content").append(e),e.click(()=>{V.addTask()}),s(u.requestServerSide));s("#content").append(e.hide())},alterTaskTableBoilerplate:e=>{s("#tasktable").length||V.setupTables();var a=window.innerHeight+window.scrollY>=document.body.offsetHeight;e(),s.isEmptyObject(t)?s("#ssubtn").addClass("disabled").hide():s("#ssubtn").removeClass("disabled").show().attr("href",V.makeSSULink(t)),a&&window.scrollTo(0,document.body.scrollHeight)},populateResults:e=>{i=e.username;var a=s("#tasktable > tbody"),t=[];s.each(e.values,(e,a)=>{V.updateTask(a),t.push(a.id)}),a.find("> tr").each(function(){var e=s(this),a=V.getTaskIDFromDOMID(e.attr("id"));t.indexOf(a)<0&&e.remove()}),e.stats?(s("#capacity").text(e.stats.processing+" / "+e.stats.capacity),s("#utilization").text(Math.round(100*e.stats.utilization)+"%"),s("#pending").text(""+e.stats.pending)):(s("#capacity").text("N/A"),s("#utilization").text("N/A"),s("#pending").text("N/A"))},updateTask:e=>{var a=s("#tasktable > tbody"),o="task-"+e.id,n=s("#"+o),a=(n.length?n.attr("status")!==e.status&&(n.html(""),V.setupTaskRow(n,o,e.status)):(s("#task-new").remove(),(n=s("<tr />")).attr({id:o,status:e.status}),a.append(n),V.setupTaskRow(n,o,e.status)),n.find(`#${o}-title`)),a=(a.text()!==e.title&&a.text(e.title),n.find(`#${o}-hostname`)),a=(a.text()!==e.hostname&&a.text(e.hostname??"N/A"),(e,a,t)=>{var i=n.find(`#${o}-statustext`);a?(a=i.html(e).find("a").attr("href",a),t&&a.text(t)):i.text()!==e&&i.text(e)});"done"===e.status?a(p.getFilter("process_link")(d.taskDone).toString(),e.url.replace("%3A",":"),e.text):"needssu"===e.status?a(p.getFilter("process_link")(d.errorTooLarge).toString(),V.makeSSULink([e])):"fail"===e.status?(a(e.text,e.url,e.url),e.restartable?n.find(`#${o}-restartbutton`).show().off().click(function(){V.eventTask(this,"restart")}):n.find(`#${o}-restartbutton`).off().hide()):a(e.text),"progress"===e.status&&V.setProgressBar(n.find(`#${o}-progress`),e.progress),"needssu"===e.status?t[e.id]=e:delete t[e.id]},setupTaskRow:(e,a,t)=>{switch(t){case"progress":e.append(s("<td />").attr("id",a+"-title")).append(s("<td />").attr("id",a+"-hostname")).append(s("<td />").attr("id",a+"-status").append(s("<span />").attr("id",a+"-statustext"))).append(s("<td />").attr("id",a+"-progress"));var i=V.eventButton(a,"abort"),i=(e.find(`#${a}-status`).append(i),e.find(`#${a}-progress`).html(u.progressbar));V.setProgressBar(i,-1),e.removeClass("success danger");break;case"done":V.appendButtons([V.eventButton(a,"remove")],e,["danger","success"],a);break;case"fail":var i=V.eventButton(a,"remove"),o=V.eventButton(a,"restart").hide();V.appendButtons([i,o],e,["success","danger"],a);break;case"needssu":V.appendButtons([V.eventButton(a,"remove")],e,["success","danger"],a);break;case"abort":V.appendButtons([],e,["success","danger"],a)}e.attr("status",t)},makeSSULink:e=>{var a=s.map(e,e=>"* "+e.url).join("\n"),e=s.map(e,e=>`| ${e.filename} | ${e.hashsum} |`).join("\n");return"https://phabricator.wikimedia.org/maniphest/task/edit/form/106/?"+s.param({title:"Server side upload for "+i,projects:"video2commons,server-side-upload-request",description:"Please upload these file(s) to Wikimedia Commons:\n\n**URLs**\n\n{{{ urls }}}\n\n//Description files are available too: append `.txt` to the URLs.//\n\n**Checksums**\n\n| **File** | **MD5** |\n{{{ checksums }}}\n\nThank you!".replace("{{{ urls }}}",a).replace("{{{ checksums }}}",e)})},setProgressBar:(e,a)=>{e=e.find(".progress-bar");a<0?(e.addClass("progress-bar-striped active").addClass("active").text(""),a=100):e.removeClass("progress-bar-striped active").text(Math.round(a)+"%"),e.attr({"aria-valuenow":a,"aria-valuemin":"0","aria-valuemax":"100",style:`width:${a}%`})},getTaskIDFromDOMID:e=>/^(?:task-)?(.+?)(?:-(?:title|statustext|progress|abortbutton|removebutton|restartbutton))?$/.exec(e)[1],eventTask:(e,a)=>{e=s(e);e.is(".disabled")||(e.off().addClass("disabled"),V.apiPost("task/"+a,{id:V.getTaskIDFromDOMID(e.attr("id"))}).done(e=>{e.error&&window.alert(e.error),V.checkStatus()}))},setText:(e,a)=>{for(var t=0;t<e.length;t++)n.find("#"+e[t]).text(a[e[t]])},eventButton:(e,a)=>s(u[a+"button"]).attr("id",e+`-${a}button`).off().click(function(){V.eventTask(this,a)}),appendButtons:(e,a,t,i)=>{a.append(s("<td />").attr("id",i+"-title"));var o=s("<td />").attr("id",i+"-status").attr("colspan","3").append(s("<span />").attr("id",i+"-statustext"));e.length&&o.append(e[0]);for(var n=1;n<e.length;n++)o.append(e[n]);a.append(o).removeClass(t[0]).addClass(t[1])},addTask:e=>{n||((n=s("<div>").html(p.render("addTask.html"))).addClass("modal fade").attr({id:"addTaskDialog",role:"dialog"}),s("body").append(n),n.find("#btn-prev").html(u.prevbutton),n.find("#btn-next").html(u.nextbutton),n.find("#btn-cancel").click(()=>{V.abortUpload()}),n.find(".modal-body").keypress(e=>{13!==(e.which||e.keyCode)||s(":focus").is("textarea")||(n.find(".modal-footer #btn-next").click(),e.preventDefault())})),V.openTaskModal(e)},openTaskModal:e=>{n.find("#dialog-spinner").hide(),n.find(".modal-body").html(`<center>${c}</center>`),V.newTask(e),n.modal({backdrop:"static"}),n.on("shown.bs.modal",()=>{n.find("#url").focus()}),V.reactivatePrevNextButtons()},newTask:e=>{r={step:"source",url:"",date:"",extractor:"",audio:!0,video:!0,subtitles:!0,filename:!0,formats:[],format:"",filedesc:"",dateCategory:"",languageCategory:"",uploadedFile:{},initialUrlValidated:!1,initialFilenameValidated:!1,initialFiledescValidated:!1,nextStep:"source",history:[],videos:[],selectedVideos:[],editingVideoIndex:null},s.extend(r,e),V.setupAddTaskDialog()},setupAddTaskDialog:()=>{switch(r.step){case"source":n.find(".modal-body").html(p.render("sourceForm.html")),n.find("a#fl").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Acceptable_licenses"),n.find("a#pd").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Material_in_the_public_domain"),n.find("a#fu").attr("href","//commons.wikimedia.org/wiki/Commons:FU"),n.find("#url").val(r.url).on("input",function(){r.url!==s(this).val()&&(r.url=s(this).val());r.url.match(/(https?:\/\/)?(www\.)?(youtube|youtu|youtube-nocookie)\.(com|be)\/(watch\?.*?(?=v=)v=|embed\/|v\/|.+\?v=)?([^&=%?]{11})/)?n.find("#youtube-warning").removeClass("hidden"):n.find("#youtube-warning").addClass("hidden")}).focus(),n.find("#video").prop("checked",r.video),n.find("#audio").prop("checked",r.audio),n.find("#subtitles").prop("checked",r.subtitles),V.initUpload();break;case"playlist":n.find(".modal-body").html(p.render("playlistForm.html",{task:r})),n.find(".video-select").each((e,a)=>{e=r.videos[e];0<=r.selectedVideos.indexOf(e)&&s(a).prop("checked",!0)});var e=n.find(".video-select:checked").length===n.find(".video-select").length;n.find("#select-all").prop("checked",e),n.find("#select-all").off().change(function(){var e=s(this).is(":checked");n.find(".video-select").prop("checked",e)}),n.find(".video-select").off().change(()=>{var e=n.find(".video-select:checked").length===n.find(".video-select").length;n.find("#select-all").prop("checked",e)}),n.find(".btn-edit").off().click(function(){var e=s(this).data("video-index");r.selectedVideos=m.getPlaylistData(),r.editingVideoIndex=e,r.history.push(r.step),r.step="target",V.setupAddTaskDialog(),V.reactivatePrevNextButtons()});break;case"target":{let a="playlist"===r.type?r.videos[r.editingVideoIndex]:r;n.find(".modal-body").html(p.render("targetForm.html",{source:a})),n.find("#filename").val(a.filename.trim()).focus(),s.each(r.formats,(e,a)=>{n.find("#format").append(s("<option></option>").text(a))}),n.find("#format").val(a.format),n.find("#filedesc").val(a.filedesc),n.find("#dateCategory").attr("placeholder",(e=a,t=(new Date).toISOString().split("T")[0],i=(t=e.date||t).split("-")[0],o=(e=e.audio&&!e.video)?d["datecategory-audio-placeholder"]:d["datecategory-video-placeholder"],e?o.replace("$1",i):o.replace("$1",i).replace("$2",t))).val(a.dateCategory||"");i=((o=a).audio&&!o.video?f:h)(o);s.each(i,(e,a)=>{n.find("#dateCategoryOptions").append(s("<option></option>").val(a))}),n.find("#dateCategory").on("input",function(){var e=b(a,s(this).val().trim());e.valid?(n.find("#dateCategoryError").hide(),n.find("#dateCategory-group").removeClass("has-error")):(n.find("#dateCategoryError").text(e.error).show(),n.find("#dateCategory-group").addClass("has-error"))}),r.video&&r.audio?(n.find("#languageCategory-group").show(),w.forEach(e=>{n.find("#languageCategory").append(s("<option></option>").val(e.category).text(e.label))}),a.languageCategory&&n.find("#languageCategory").val(a.languageCategory)):n.find("#languageCategory-group").hide();break}case"confirm":t="playlist"===r.type?p.render("playlistConfirmForm.html",{task:r}):p.render("confirmForm.html"),o=(n.find(".modal-body").html(t),[]);r.video&&o.push(d.video),r.audio&&o.push(d.audio),r.subtitles&&o.push(d.subtitles),n.find("#keep").text(o.join(", ")),V.setText(["url","extractor","filename","format"],r),n.find("#filedesc").val(r.filedesc),n.find("#btn-next").focus()}var t,i,o},reactivatePrevNextButtons:()=>{switch(n.find("#dialog-spinner").hide(),r.step){case"source":n.find("#btn-prev").addClass("disabled").off(),n.find("#btn-next").html(u.nextbutton),V.setPrevNextButton("next");break;case"playlist":V.setPrevNextButton("prev"),n.find("#btn-next").html(u.nextbutton),V.setPrevNextButton("next");break;case"target":V.setPrevNextButton("prev"),"playlist"===r.type?n.find("#btn-next").html(u.confirmbutton):n.find("#btn-next").html(u.nextbutton),V.setPrevNextButton("next");break;case"confirm":V.setPrevNextButton("prev"),n.find("#btn-next").removeClass("disabled").html(u.confirmbutton).off().click(()=>{V.disablePrevNext(!1),n.modal("hide"),s("#tasktable > tbody").append(`<tr id="task-new"><td colspan="3">${c}</td></tr>`),window.scrollTo(0,document.body.scrollHeight),r.uploadedFile={};let a=[];if("playlist"===r.type)a=r.selectedVideos.map(e=>{let a=e.filedesc;return e.dateCategory&&(a+=`
[[Category:${e.dateCategory}]]`),e.languageCategory&&(a+=`
[[Category:${e.languageCategory}]]`),{url:e.url,extractor:e.extractor,subtitles:r.subtitles,filename:e.filename,filedesc:a,format:e.format}});else{let e=r.filedesc;r.dateCategory&&(e+=`
[[Category:${r.dateCategory}]]`),r.languageCategory&&(e+=`
[[Category:${r.languageCategory}]]`),a.push({url:r.url,extractor:r.extractor,subtitles:r.subtitles,filename:r.filename,filedesc:e,format:r.format})}V.runWithConcurrency(a.map(e=>()=>v.startTask(e).done(e=>{e.error&&window.alert(e.error)}))).always(()=>{V.checkStatus()})})}},setPrevNextButton:e=>{n.find("#btn-"+e).removeClass("disabled").off().click(()=>{V.processInput(e)})},disablePrevNext:e=>{n.find(".modal-body #dialog-errorbox").hide(),n.find("#btn-prev").addClass("disabled").off(),n.find("#btn-next").addClass("disabled").off(),e&&n.find("#dialog-spinner").show()},processInput:e=>{var a=r.step,t=k[a];t?"next"===e?(t=t(),V.promiseWorkingOn(t.done(()=>{V.transitionStep(e)}))):(V.transitionStep(e),V.reactivatePrevNextButtons()):console.error("Unknown step:",a)},transitionStep:e=>{"prev"===e&&0<r.history.length?(r.step=r.history.pop(),V.setupAddTaskDialog()):"next"===e&&(e=r.history[r.history.length-1],r.nextStep===e?r.step=r.history.pop():(r.history.push(r.step),r.step=r.nextStep),V.setupAddTaskDialog())},promiseWorkingOn:e=>(V.disablePrevNext(!0),e.fail(e=>{n.find(".modal-body #dialog-errorbox").length||n.find(".modal-body").append(s('<div class="alert alert-danger" id="dialog-errorbox"></div>')),n.find(".modal-body #dialog-errorbox").text("Error: "+e).show()}).always(V.reactivatePrevNextButtons)),abortUpload:(e,a)=>{e&&"pending"===e.state()&&e.reject(a),window.jqXHR?.abort&&window.jqXHR.abort()},initUpload:()=>{var i;window.jqXHR=n.find("#fileupload").fileupload({dataType:"json",formData:{_csrf_token:g},maxChunkSize:4<<20,sequentialUploads:!0}).on("fileuploadadd",(e,a)=>{window.jqXHR=a.submit(),i=s.Deferred(),V.promiseWorkingOn(i.promise()),n.find("#src-url").hide(),n.find("#src-uploading").show(),n.find("#upload-abort").off().click(()=>{V.abortUpload(i,"Upload aborted.")})}).on("fileuploadchunkdone",(e,a)=>{a.result.filekey&&(a.formData.filekey=a.result.filekey),"Continue"===a.result.result?a.result.offset!==a.uploadedBytes&&V.abortUpload(i,`Unexpected offset! Expected: ${a.uploadedBytes} Returned: `+a.result.offset):a.result.error?V.abortUpload(i,a.result.error):V.abortUpload()}).on("fileuploadprogressall",(e,a)=>{V.setProgressBar(n.find("#upload-progress"),a.loaded/a.total*100)}).on("fileuploadalways",(e,a)=>{delete a.formData.filekey,V.reactivatePrevNextButtons(),n.find("#src-url").show(),n.find("#src-uploading").hide()}).on("fileuploadfail",()=>{V.abortUpload(i,"Something went wrong while uploading... try again?")}).on("fileuploaddone",(e,a)=>{var t;"Success"===a.result.result?(t="uploads:"+a.result.filekey,r.uploadedFile[t]=a.files[0],n.find("#url").val(t),i.resolve()):V.abortUpload(i,"Upload does not seem to be successful.")})},askAPI:(e,a,i,o=null)=>{null==o&&(o=r);var n=s.Deferred();return V.apiPost(e,a).done(e=>{if(e.error)n.reject(e.error);else{for(var a=0;a<i.length;a++){var t=i[a];l?.[t]?o[t]=l[t]:e[t]&&(o[t]=e[t])}n.resolve(e)}}).fail(()=>{n.reject("Something weird happened. Please try again.")}),n.promise()},apiPost:(e,a)=>(a._csrf_token=g,s.post("api/"+e,a)),runWithConcurrency(e,a=5){let t=e.slice(),i=s.Deferred(),o=[],n=0,r=0,l=()=>{if(r>=t.length&&0===n)i.resolve(o);else for(;n<a&&r<t.length;){let a=r++;var e=t[a];n++,e().then(e=>{o[a]=e}).fail(e=>{o[a]={error:e}}).always(()=>{n--,l()})}};return l(),i.promise()}};let w=[{label:"Unselected",category:""},{label:"English (en)",category:"Videos in English"},{label:"American English (en-US)",category:"Videos in American English"},{label:"Australian English (en-AU)",category:"Videos in Australian English"},{label:"British English (en-GB)",category:"Videos in British English"},{label:"Canadian English (en-CA)",category:"Videos in Canadian English"},{label:"Spanish (es)",category:"Videos in Spanish"},{label:"Portuguese (pt)",category:"Videos in Portuguese"},{label:"Brazilian Portuguese (pt-BR)",category:"Videos in Brazilian Portuguese"},{label:"Chinese (zh)",category:"Videos in Chinese"},{label:"Cantonese (yue)",category:"Videos in Cantonese"},{label:"Mandarin (cmn)",category:"Videos in Mandarin"},{label:"Japanese (ja)",category:"Videos in Japanese"},{label:"Korean (ko)",category:"Videos in Korean"},{label:"Hindi (hi)",category:"Videos in Hindi"},{label:"Arabic (ar)",category:"Videos in Arabic"},{label:"Russian (ru)",category:"Videos in Russian"},{label:"German (de)",category:"Videos in German"},{label:"Bavarian (bar)",category:"Videos in Bavarian"},{label:"French (fr)",category:"Videos in French"},{label:"Italian (it)",category:"Videos in Italian"},{label:"Dutch (nl)",category:"Videos in Dutch"},{label:"Polish (pl)",category:"Videos in Polish"},{label:"Turkish (tr)",category:"Videos in Turkish"},{label:"Albanian (sq)",category:"Videos in Albanian"},{label:"Algerian Arabic (arq)",category:"Videos in Algerian Arabic"},{label:"Egyptian Arabic (arz)",category:"Videos in Egyptian Arabic"},{label:"Moroccan Arabic (ary)",category:"Videos in Moroccan Arabic"},{label:"North Levantine Arabic (apc)",category:"Videos in North Levantine Arabic"},{label:"Amharic (am)",category:"Videos in Amharic"},{label:"American Sign Language (ase)",category:"Videos in American Sign Language"},{label:"Ancient Greek (grc)",category:"Videos in Ancient Greek"},{label:"Armenian (hy)",category:"Videos in Armenian"},{label:"Assamese (as)",category:"Videos in Assamese"},{label:"Asturian (ast)",category:"Videos in Asturian"},{label:"Avar (av)",category:"Videos in Avar"},{label:"Azerbaijani (az)",category:"Videos in Azerbaijani"},{label:"Balinese (ban)",category:"Videos in Balinese"},{label:"Balochi (bal)",category:"Videos in Balochi"},{label:"Bangla (bn)",category:"Videos in Bangla"},{label:"Basque (eu)",category:"Videos in Basque"},{label:"Belarusian (be)",category:"Videos in Belarusian"},{label:"Bislama (bi)",category:"Videos in Bislama"},{label:"Bosnian (bs)",category:"Videos in Bosnian"},{label:"Breton (br)",category:"Videos in Breton"},{label:"British Sign Language (bfi)",category:"Videos in British Sign Language"},{label:"Bulgarian (bg)",category:"Videos in Bulgarian"},{label:"Burmese (my)",category:"Videos in Burmese"},{label:"Catalan (ca)",category:"Videos in Catalan"},{label:"Cebuano (ceb)",category:"Videos in Cebuano"},{label:"Central Bikol (bcl)",category:"Videos in Central Bikol"},{label:"Chamorro (ch)",category:"Videos in Chamorro"},{label:"Cherokee (chr)",category:"Videos in Cherokee"},{label:"Cornish (kw)",category:"Videos in Cornish"},{label:"Crimean Tatar (crh)",category:"Videos in Crimean Tatar"},{label:"Croatian (hr)",category:"Videos in Croatian"},{label:"Czech (cs)",category:"Videos in Czech"},{label:"Danish (da)",category:"Videos in Danish"},{label:"Dari (prs)",category:"Videos in Dari"},{label:"Esperanto (eo)",category:"Videos in Esperanto"},{label:"Estonian (et)",category:"Videos in Estonian"},{label:"Farsi (fa)",category:"Videos in Farsi"},{label:"Fijian (fj)",category:"Videos in Fijian"},{label:"Finnish (fi)",category:"Videos in Finnish"},{label:"Galician (gl)",category:"Videos in Galician"},{label:"Georgian (ka)",category:"Videos in Georgian"},{label:"Greek (el)",category:"Videos in Greek"},{label:"Greenlandic (kl)",category:"Videos in Greenlandic"},{label:"Guarani (gn)",category:"Videos in Guarani"},{label:"Gujarati (gu)",category:"Videos in Gujarati"},{label:"Haitian Creole (ht)",category:"Videos in Haitian Creole"},{label:"Hakka (hak)",category:"Videos in Hakka"},{label:"Min Dong Chinese (cdo)",category:"Videos in Min Dong Chinese"},{label:"Hausa (ha)",category:"Videos in Hausa"},{label:"Hebrew (he)",category:"Videos in Hebrew"},{label:"Hungarian (hu)",category:"Videos in Hungarian"},{label:"Icelandic (is)",category:"Videos in Icelandic"},{label:"Ido (io)",category:"Videos in Ido"},{label:"Igbo (ig)",category:"Videos in Igbo"},{label:"Indonesian (id)",category:"Videos in Indonesian"},{label:"Irish (ga)",category:"Videos in Irish"},{label:"Jamaican Patois (jam)",category:"Videos in Jamaican Patois"},{label:"Javanese (jv)",category:"Videos in Javanese"},{label:"Judaeo-Spanish (lad)",category:"Videos in Judaeo-Spanish"},{label:"Kannada (kn)",category:"Videos in Kannada"},{label:"Kashmiri (ks)",category:"Videos in Kashmiri"},{label:"Kazakh (kk)",category:"Videos in Kazakh"},{label:"Khasi (kha)",category:"Videos in Khasi"},{label:"Khmer (km)",category:"Videos in Khmer"},{label:"Komi (kv)",category:"Videos in Komi"},{label:"Kotava (avk)",category:"Videos in Kotava"},{label:"Kurdish (ku)",category:"Videos in Kurdish"},{label:"Kyrgyz (ky)",category:"Videos in Kyrgyz"},{label:"K'iche' (quc)",category:"Videos in K'iche'"},{label:"Lakota (lkt)",category:"Videos in Lakota"},{label:"Lao (lo)",category:"Videos in Lao"},{label:"Latin (la)",category:"Videos in Latin"},{label:"Latvian (lv)",category:"Videos in Latvian"},{label:"Leonese (roa-leon)",category:"Videos in Leonese"},{label:"Limburgish (li)",category:"Videos in Limburgish"},{label:"Lithuanian (lt)",category:"Videos in Lithuanian"},{label:"Lojban (jbo)",category:"Videos in Lojban"},{label:"Low German (nds)",category:"Videos in Low German"},{label:"Lozi (loz)",category:"Videos in Lozi"},{label:"Luxembourgish (lb)",category:"Videos in Luxembourgish"},{label:"Macedonian (mk)",category:"Videos in Macedonian"},{label:"Malay (ms)",category:"Videos in Malay"},{label:"Malayalam (ml)",category:"Videos in Malayalam"},{label:"Maltese (mt)",category:"Videos in Maltese"},{label:"Manx (gv)",category:"Videos in Manx"},{label:"Mapudungun (arn)",category:"Videos in Mapudungun"},{label:"Marathi (mr)",category:"Videos in Marathi"},{label:"Marwari (mwr)",category:"Videos in Marwari"},{label:"Mirandese (mwl)",category:"Videos in Mirandese"},{label:"Mongolian (mn)",category:"Videos in Mongolian"},{label:"Mossi (mos)",category:"Videos in Mossi"},{label:"Neapolitan (nap)",category:"Videos in Neapolitan"},{label:"Sicilian (scn)",category:"Videos in Sicilian"},{label:"Nepali (ne)",category:"Videos in Nepali"},{label:"Northern Sami (se)",category:"Videos in Northern Sami"},{label:"Norwegian (no)",category:"Videos in Norwegian"},{label:"Occitan (oc)",category:"Videos in Occitan"},{label:"Odia (or)",category:"Videos in Odia"},{label:"Pashto (ps)",category:"Videos in Pashto"},{label:"Punjabi (pa)",category:"Videos in Punjabi"},{label:"Quechua (qu)",category:"Videos in Quechua"},{label:"Romanian (ro)",category:"Videos in Romanian"},{label:"Saint Lucian Creole (acf)",category:"Videos in Saint Lucian Creole"},{label:"Samoan (sm)",category:"Videos in Samoan"},{label:"Sanskrit (sa)",category:"Videos in Sanskrit"},{label:"Santali (sat)",category:"Videos in Santali"},{label:"Sardinian (sc)",category:"Videos in Sardinian"},{label:"Serbian (sr)",category:"Videos in Serbian"},{label:"Serbo-Croatian (sh)",category:"Videos in Serbo-Croatian"},{label:"Silesian (szl)",category:"Videos in Silesian"},{label:"Sindhi (sd)",category:"Videos in Sindhi"},{label:"Slovak (sk)",category:"Videos in Slovak"},{label:"Slovene (sl)",category:"Videos in Slovene"},{label:"Somali (so)",category:"Videos in Somali"},{label:"Swahili (sw)",category:"Videos in Swahili"},{label:"Swedish (sv)",category:"Videos in Swedish"},{label:"Sylheti (syl)",category:"Videos in Sylheti"},{label:"Tagalog (tl)",category:"Videos in Tagalog"},{label:"Tamazight (zgh)",category:"Videos in Tamazight"},{label:"Tamil (ta)",category:"Videos in Tamil"},{label:"Tatar (tt)",category:"Videos in Tatar"},{label:"Telugu (te)",category:"Videos in Telugu"},{label:"Tetum (tet)",category:"Videos in Tetum"},{label:"Thai (th)",category:"Videos in Thai"},{label:"Tok Pisin (tpi)",category:"Videos in Tok Pisin"},{label:"Toki Pona (tok)",category:"Videos in Toki Pona"},{label:"Tsonga (ts)",category:"Videos in Tsonga"},{label:"Tuvan (tyv)",category:"Videos in Tuvan"},{label:"Twi (tw)",category:"Videos in Twi"},{label:"Ukrainian (uk)",category:"Videos in Ukrainian"},{label:"Urdu (ur)",category:"Videos in Urdu"},{label:"Veps (vep)",category:"Videos in Veps"},{label:"Vietnamese (vi)",category:"Videos in Vietnamese"},{label:"Volapük (vo)",category:"Videos in Volapük"},{label:"Walloon (wa)",category:"Videos in Walloon"},{label:"Welsh (cy)",category:"Videos in Welsh"},{label:"West Frisian (fy)",category:"Videos in West Frisian"},{label:"Wolof (wo)",category:"Videos in Wolof"},{label:"Xhosa (xh)",category:"Videos in Xhosa"},{label:"Yiddish (yi)",category:"Videos in Yiddish"},{label:"Yoruba (yo)",category:"Videos in Yoruba"},{label:"Yucatec (yua)",category:"Videos in Yucatec"}];s(document).ready(()=>{V.init()})})(jQuery);