name: Deploy Encoders (CloudVPS)

on:
  workflow_dispatch:

  # Uncomment to allow the workflow to run automatically when changes are
  # merged into master (only for files that affect this deployment).
  #
  # push:
  #   branches: [master]
  #   paths:
  #     - 'puppet/**'
  #     - 'pyproject.toml'
  #     - 'utils/deploy-cloudvps-encoders.sh'
  #     - 'uv.lock'
  #     - 'video2commons/backend/**'
  #     - 'video2commons/config.py'
  #     - 'video2commons/exceptions.py'
  #     - 'video2commons/shared/**'

jobs:
  deploy-cloudvps-encoders:
    name: Deploy Encoders (CloudVPS)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          cat >> ~/.ssh/config << 'EOF'
          Host *
              IdentityFile ~/.ssh/id_ed25519
              IdentitiesOnly yes
              StrictHostKeyChecking no

          Host *.wikimedia.cloud
              ProxyJump login.toolforge.org:22
          EOF
          chmod 600 ~/.ssh/config
          mkdir -p ~/.ssh/sockets

      - name: Deploy
        run: ./utils/deploy-cloudvps-encoders.sh
        env:
          V2C_USERNAME: ${{ secrets.V2C_USERNAME }}
          V2C_REDIS_PW: ${{ secrets.V2C_REDIS_PW }}
          V2C_CONSUMER_SECRET: ${{ secrets.V2C_CONSUMER_SECRET }}
          V2C_CONSUMER_KEY: ${{ secrets.V2C_CONSUMER_KEY }}
