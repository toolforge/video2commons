!function(a){"use strict";var i=window.video2commons={};i.init=function(){a("#content").html('<center><img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32">&nbsp;&nbsp;LOADING...</center>'),this.checkStatus()},i.checkStatus=function(){window.lastStatusCheck&&clearTimeout(window.lastStatusCheck);var t="/video2commons/api/status";a.get(t).done(function(t){a("#tasktable").length||i.setupTables(),i.populateResults(t),t.hasrunning?window.lastStatusCheck=setTimeout(i.checkStatus,5e3):window.lastStatusCheck=setTimeout(i.checkStatus,6e4)}).fail(function(){a("#content").html('<div class="alert alert-danger">Something went terribly wrong. Please refresh this page or contact [[:commons:User:Zhuyifei1999]].</div>')})},i.setupTables=function(){a("#content").html('<div class="container" id="content"><h4>Your tasks:</h4>			<table id="tasktable" class="table"><tbody></tbody></table></div>');var t=a('<input class="btn btn-primary btn-success btn-md" type="button" value="Add task...">');a("#content").append(t),t.click(function(){i.addTask()});var e=a('<a class="btn btn-primary btn-success btn-md pull-right disabled" id="ssubtn">Create server-side upload ticket in one go (recommended)</a>');a("#content").append(e.hide())},i.setProgressBar=function(a,i){var t=a.find(".progress-bar");0>i?(t.addClass("progress-bar-striped active").addClass("active").text(""),i=100):t.removeClass("progress-bar-striped active").text(i+"%"),t.attr({"aria-valuenow":i,"aria-valuemin":"0","aria-valuemax":"100",style:"width:"+i+"%"})},i.getTaskIDFromDOMID=function(a){var i=/^(?:task-)?(.+?)(?:-(?:title|statustext|progress|removebutton|restartbutton))?$/.exec(a);return i[1]},i.populateResults=function(t){var e=a("#tasktable > tbody");a("#task-new").remove(),e.find("> tr").each(function(){var e=a(this),d=i.getTaskIDFromDOMID(e.attr("id"));t.ids.indexOf(d)<0&&e.remove()}),a.each(t.values,function(t,d){var s="task-"+d.id,o=a("#"+s),n=!1;o.length?o.attr("status")!==d.status&&(o.html(""),n=!0):(o=a("<tr />"),o.attr({id:s,status:d.status}),e.append(o),n=!0);var l;if(n){switch(d.status){case"progress":o.append(a("<td />").attr("id",s+"-title").attr("width","30%")).append(a("<td />").attr("id",s+"-status").attr("width","40%").append(a("<span />").attr("id",s+"-statustext"))).append(a("<td />").attr("id",s+"-progress").attr("width","30%"));var r=o.find("#"+s+"-progress").html('<div class="progress"><div class="progress-bar" role="progressbar"></div></div>');i.setProgressBar(r,-1),o.removeClass("success danger");break;case"done":o.append(a("<td />").attr("id",s+"-title").attr("width","30%")),l=a('<button type="button" class="btn btn-danger btn-xs pull-right"><span class="glyphicon glyphicon-trash"></span> Remove</button>').attr("id",s+"-removebutton").off().click(function(){a(this).addClass("disabled"),i.removeTask(i.getTaskIDFromDOMID(a(this).attr("id")))}),o.append(a("<td />").attr("id",s+"-status").attr("width","70%").attr("colspan","2").append(a("<span />").attr("id",s+"-statustext")).append(l)).removeClass("danger").addClass("success");break;case"fail":o.append(a("<td />").attr("id",s+"-title").attr("width","30%")),l=a('<button type="button" class="btn btn-danger btn-xs pull-right"><span class="glyphicon glyphicon-trash"></span> Remove</button>').attr("id",s+"-removebutton").off().click(function(){a(this).addClass("disabled"),i.removeTask(i.getTaskIDFromDOMID(a(this).attr("id")))});var c=a('<button type="button" class="btn btn-warning btn-xs pull-right"><span class="glyphicon glyphicon-repeat"></span> Restart</button>').attr("id",s+"-restartbutton").hide();o.append(a("<td />").attr("id",s+"-status").attr("width","70%").attr("colspan","2").append(a("<span />").attr("id",s+"-statustext")).append(l).append(c)).removeClass("success").addClass("danger");break;case"needssu":o.append(a("<td />").attr("id",s+"-title").attr("width","30%")),l=a('<button type="button" class="btn btn-danger btn-xs pull-right"><span class="glyphicon glyphicon-trash"></span> Remove</button>').attr("id",s+"-removebutton").off().click(function(){a(this).addClass("disabled"),i.removeTask(i.getTaskIDFromDOMID(a(this).attr("id")))});var p=a("<a>request a server-side upload</a>").attr("href",d.url);o.append(a("<td />").attr("id",s+"-status").attr("width","70%").attr("colspan","2").append(a("<span />").attr("id",s+"-statustext").append(p)).append(l)).removeClass("success").addClass("danger")}o.attr("status",d.status)}o.find("#"+s+"-title").text(d.title),"done"===d.status?o.find("#"+s+"-statustext").html("Your task is done. You may find your upload at <a></a>.").find("a").attr("href",d.url).text(d.text):"needssu"===d.status?o.find("#"+s+"-statustext").html("File too large to upload directly! You may want to <a>request a server-side upload</a>.").find("a").attr("href",d.url):"fail"===d.status?(o.find("#"+s+"-statustext").text(d.text),d.restartable?o.find("#"+s+"-restartbutton").show().off().click(function(){a(this).addClass("disabled"),i.restartTask(i.getTaskIDFromDOMID(a(this).attr("id")))}):o.find("#"+s+"-restartbutton").off().hide()):o.find("#"+s+"-statustext").text(d.text),"progress"===d.status&&i.setProgressBar(o.find("#"+s+"-progress"),d.progress)}),t.ssulink?a("#ssubtn").removeClass("disabled").show().attr("href",t.ssulink):a("#ssubtn").addClass("disabled").hide()},i.addTask=function(){window.addTaskDialog||(window.addTaskDialog=a('\n<div class="modal fade" id="addTaskDialog" role="dialog">\n  <div class="modal-dialog">\n    <div class="modal-content">\n      <div class="modal-header">\n        <button type="button" class="close" data-dismiss="modal">&times;</button>\n        <h4><span class="glyphicon glyphicon-plus"></span> Add Task</h4>\n      </div>\n      <div class="modal-body" style="padding:40px 50px;"></div>\n      <div class="modal-footer">\n        <button type="button" class="btn btn-danger pull-left" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span> Cancel</button>\n        <button type="submit" class="btn btn-success pull-right" id="btn-next">Next <span class="glyphicon glyphicon-chevron-right"></span></button>\n        <button type="button" class="btn btn-warning pull-right disabled" id="btn-prev"><span class="glyphicon glyphicon-chevron-left"></span> Back</button>\n        <img class="pull-right" alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32" id="dialog-spinner">\n      </div>\n    </div>\n  </div>\n</div>'),a("body").append(window.addTaskDialog)),window.addTaskDialog.find("#dialog-spinner").hide(),window.addTaskDialog.find(".modal-body").html('<center><img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32"></center>'),this.newTask(),window.addTaskDialog.modal()},i.newTask=function(){var t="/video2commons/api/task/new";a.post(t).done(function(a){window.newTaskTempID=a.id,i.setupAddTaskDialog(a)}).fail(function(){window.addTaskDialog.html('<div class="alert alert-danger">Something went wrong. Please try again, refresh this page, or contact [[:commons:User:Zhuyifei1999]].</div>')})},i.setupAddTaskDialog=function(t){switch(window.addTaskDialog.find("#dialog-spinner").hide(),"error"!==t.step&&(window.addTaskStep=t.step),t.step){case"error":window.addTaskDialog.find(".modal-body #dialog-errorbox").length||window.addTaskDialog.find(".modal-body").append(a('<div class="alert alert-danger" id="dialog-errorbox"></div>')),window.addTaskDialog.find(".modal-body #dialog-errorbox").text("Error: "+t.error).show();break;case"source":window.addTaskDialog.find(".modal-body").html('\n          <form role="form">\n            <div class="form-group">\n              <label for="url"><span class="glyphicon glyphicon-import"></span> URL</label>\n              <input type="text" class="form-control" id="url" placeholder="http://example.com/examplevideo">\n            </div>\n            <div class="checkbox">\n              <label><input type="checkbox" value="" checked id="video">Keep video</label>\n            </div>\n            <div class="checkbox">\n              <label><input type="checkbox" value="" checked id="audio">Keep audio</label>\n            </div>\n            <div class="checkbox">\n              <label><input type="checkbox" value="" checked id="subtitles">Import subtitles</label>\n            </div>\n            <div class="alert alert-info">\n              Note:\n              <ul>\n                <li>Playlists will not be processed correctly. Some sites (such as Youku and Comedy Central) make use of multipart videos, interpreted as playlists, and will not be processed correctly either.</li>\n                <li>If the media does not include video or audio tracks, please uncheck the corresponding checkboxes; otherwise conversion may fail, even if the format is free.</li>\n                <li>If "Import subtitles" is checked, subtitles will be imported, excluding auto-generated ones.</li>\n                <li>What if I need to convert and upload a file on my computer? Well, while NFS and Grid engine is still here, you can use <a href="//tools.wmflabs.org/videoconvert/">videoconvert</a></li> tool.\n              </ul>\n              <b>Important note:</b> Only upload <a href="//commons.wikimedia.org/wiki/Commons:Licensing#Acceptable_licenses" title="Commons:Licensing">freely licensed</a> or <a href="//commons.wikimedia.org/wiki/Commons:Licensing#Material_in_the_public_domain" title="Commons:Licensing">public domain</a> content. <a href="//commons.wikimedia.org/wiki/Commons:FU" title="Commons:FU" class="mw-redirect">Fair use</a> is not allowed on commons.\n            </div>\n          </form>'),window.addTaskDialog.find("#url").val(t.url),window.addTaskDialog.find("#video").prop("checked",t.video),window.addTaskDialog.find("#audio").prop("checked",t.audio),window.addTaskDialog.find("#subtitles").prop("checked",t.subtitles);break;case"target":window.addTaskDialog.find(".modal-body").html('\n          <form role="form">\n            <div class="form-group">\n              <label for="filename"><span class="glyphicon glyphicon-export"></span> Filename</label>\n              <div class="form-inline">\n                <input type="text" class="form-control" id="filename" placeholder="Example" size="30">\n                <p class="form-control-static">.</p>\n                <select class="form-control" id="format" style="max-width:40%;"></select>\n              </div>\n            </div>\n            <div class="form-group">\n              <label for="filedesc"><span class="glyphicon glyphicon-list"></span> File description page:</label>\n              <textarea class="form-control" rows="10" id="filedesc"></textarea>\n            </div>\n            <div class="alert alert-info">\n              Note:\n              <ul>\n                <li>The file extension set above is used if and only if the video is in a non-free format, which transcoding is required. Videos in free formats will keep their extensions.</li>\n              </ul>\n            </div>\n          </form>'),window.addTaskDialog.find("#filename").val(t.filename),a.each(t.formats,function(i,t){window.addTaskDialog.find("#format").append(a("<option></option>").text(t))}),window.addTaskDialog.find("#format").val(t.format),window.addTaskDialog.find("#filedesc").val(t.filedesc);break;case"confirm":window.addTaskDialog.find(".modal-body").html('\n          <form class="form-horizontal" role="form">\n            <div class="form-group">\n              <label class="control-label col-sm-2" for="url">URL:</label>\n              <div class="col-sm-10">\n                <p class="form-control-static" id="url"></p>\n              </div>\n            </div>\n            <div class="form-group">\n              <label class="control-label col-sm-2" for="extractor">Extractor:</label>\n              <div class="col-sm-10">\n                <p class="form-control-static" id="extractor"></p>\n              </div>\n            </div>\n            <div class="form-group">\n              <label class="control-label col-sm-2" for="keep">Keep:</label>\n              <div class="col-sm-10">\n                <p class="form-control-static" id="keep"></p>\n              </div>\n            </div>\n            <div class="form-group">\n              <label class="control-label col-sm-2" for="filename">Target filename:</label>\n              <div class="col-sm-10">\n                <p class="form-control-static" id="filename"></p>\n              </div>\n            </div>\n            <div class="form-group">\n              <label class="control-label col-sm-2" for="format">Transcoding format:</label>\n              <div class="col-sm-10">\n                <p class="form-control-static" id="format"></p>\n              </div>\n            </div>\n            <div class="form-group">\n              <label class="control-label col-sm-2" for="filedesc">File description page:</label>\n              <div class="col-sm-10">\n                <textarea class="form-control" rows="5" id="filedesc" readonly="readonly"></textarea>\n              </div>\n            </div>\n            <div class="alert alert-info">\n              Note:\n              <ul>\n                <li>Please confirm the task or click "Back" to change the parameters. By clicking "Confirm", the task will be submitted and executed. Due to technical restrictions, a task cannot be easily aborted once it is submitted.</li>\n              </ul>\n            </div>\n          </form>'),window.addTaskDialog.find("#url").text(t.url),window.addTaskDialog.find("#extractor").text(t.extractor),window.addTaskDialog.find("#keep").text(t.keep),window.addTaskDialog.find("#filename").text(t.filename),window.addTaskDialog.find("#format").text(t.format),window.addTaskDialog.find("#filedesc").val(t.filedesc)}switch(window.addTaskStep){case"source":window.addTaskDialog.find("#btn-prev").addClass("disabled").off(),window.addTaskDialog.find("#btn-next").removeClass("disabled").html('Next <span class="glyphicon glyphicon-chevron-right"></span>').off(),window.addTaskDialog.find("#btn-next").click(function(){window.addTaskDialog.find(".modal-body #dialog-errorbox").hide(),window.addTaskDialog.find("#btn-prev").addClass("disabled").off(),window.addTaskDialog.find("#btn-next").addClass("disabled").off(),window.addTaskDialog.find("#dialog-spinner").show();var t={id:window.newTaskTempID,action:"next",step:window.addTaskStep,url:window.addTaskDialog.find("#url").val(),video:window.addTaskDialog.find("#video").is(":checked"),audio:window.addTaskDialog.find("#audio").is(":checked"),subtitles:window.addTaskDialog.find("#subtitles").is(":checked")};a.post("/video2commons/api/task/submit",t).done(function(a){i.setupAddTaskDialog(a)})});break;case"target":window.addTaskDialog.find("#btn-prev").removeClass("disabled").off(),window.addTaskDialog.find("#btn-next").removeClass("disabled").html('Next <span class="glyphicon glyphicon-chevron-right"></span>').off(),window.addTaskDialog.find("#btn-prev").click(function(){window.addTaskDialog.find(".modal-body #dialog-errorbox").hide(),window.addTaskDialog.find("#btn-prev").addClass("disabled").off(),window.addTaskDialog.find("#btn-next").addClass("disabled").off(),window.addTaskDialog.find("#dialog-spinner").show();var t={id:window.newTaskTempID,action:"prev",step:window.addTaskStep,filename:window.addTaskDialog.find("#filename").val(),format:window.addTaskDialog.find("#format").val(),filedesc:window.addTaskDialog.find("#filedesc").val()};a.post("/video2commons/api/task/submit",t).done(function(a){i.setupAddTaskDialog(a)})}),window.addTaskDialog.find("#btn-next").click(function(){window.addTaskDialog.find(".modal-body #dialog-errorbox").hide(),window.addTaskDialog.find("#btn-prev").addClass("disabled").off(),window.addTaskDialog.find("#btn-next").addClass("disabled").off(),window.addTaskDialog.find("#dialog-spinner").show();var t={id:window.newTaskTempID,action:"next",step:window.addTaskStep,filename:window.addTaskDialog.find("#filename").val(),format:window.addTaskDialog.find("#format").val(),filedesc:window.addTaskDialog.find("#filedesc").val()};a.post("/video2commons/api/task/submit",t).done(function(a){i.setupAddTaskDialog(a)})});break;case"confirm":window.addTaskDialog.find("#btn-prev").removeClass("disabled").off(),window.addTaskDialog.find("#btn-next").removeClass("disabled").html('Confirm <span class="glyphicon glyphicon-ok"></span>').off(),window.addTaskDialog.find("#btn-prev").click(function(){window.addTaskDialog.find(".modal-body #dialog-errorbox").hide(),window.addTaskDialog.find("#btn-prev").addClass("disabled").off(),window.addTaskDialog.find("#btn-next").addClass("disabled").off(),window.addTaskDialog.find("#dialog-spinner").show();var t={id:window.newTaskTempID,action:"prev",step:window.addTaskStep};a.post("/video2commons/api/task/submit",t).done(function(a){i.setupAddTaskDialog(a)})}),window.addTaskDialog.find("#btn-next").click(function(){window.addTaskDialog.find(".modal-body #dialog-errorbox").hide(),window.addTaskDialog.find("#btn-prev").addClass("disabled").off(),window.addTaskDialog.find("#btn-next").addClass("disabled").off(),window.addTaskDialog.modal("hide"),a("#tasktable > tbody").append('<tr id="task-new"><td colspan="3"><img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32"></td></tr>');var t={id:window.newTaskTempID,action:"next",step:window.addTaskStep};a.post("/video2commons/api/task/submit",t).done(function(a){a.error&&window.alert(a.error),i.checkStatus()})})}},i.removeTask=function(t){a.post("/video2commons/api/task/remove",{id:t}).done(function(a){a.error&&window.alert(a.error),i.checkStatus()})},i.restartTask=function(t){a.post("/video2commons/api/task/restart",{id:t}).done(function(a){a.error&&window.alert(a.error),i.checkStatus()})},a(document).ready(function(){i.init()})}(jQuery);